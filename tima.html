<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Доска заданий</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@keyframes lines {
  0% { background-position: 0 0, 0 0; }
  100% { background-position: 1000px 0, 0 1000px; }
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes glow {
  0%, 100% { box-shadow: 0 0 15px rgba(0,255,255,0.3); }
  50% { box-shadow: 0 0 25px rgba(0,255,255,0.7); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes flyAway {
  0% { transform: translateX(0) scale(1); opacity: 1; }
  50% { transform: translateX(100px) scale(0.8); opacity: 0.7; }
  100% { transform: translateX(1000px) scale(0.5); opacity: 0; }
}

body {
  margin: 0;
  font-family: 'Press Start 2P', cursive;
  background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: "";
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: repeating-linear-gradient(45deg, rgba(0,255,255,0.05) 0 1px, transparent 1px 12px),
              repeating-linear-gradient(-45deg, rgba(255,0,255,0.05) 0 1px, transparent 1px 12px);
  animation: lines 40s linear infinite;
  z-index: 0;
  pointer-events: none;
}

header {
  text-align: center;
  padding: 20px 0;
  position: relative;
  z-index: 1;
}

h1 {
  font-size: 28px;
  color: #00e5ff;
  text-shadow: 0 0 10px #00e5ff, 0 0 20px #00e5ff;
  margin-bottom: 10px;
  animation: float 5s ease-in-out infinite;
}

.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
  gap: 10px;
  flex-wrap: wrap;
}

.tab-btn {
  background: rgba(27, 27, 27, 0.7);
  color: #a0fff0;
  border: 1px solid rgba(0,255,255,0.3);
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  transition: all 0.3s;
}

.tab-btn.active {
  background: rgba(0,255,255,0.2);
  color: #00e5ff;
  box-shadow: 0 0 10px rgba(0,255,255,0.5);
}

.tab-btn:hover {
  background: rgba(0,255,255,0.1);
}

.filter-bar {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filter-btn {
  background: rgba(27, 27, 27, 0.7);
  color: #a0fff0;
  border: 1px solid rgba(0,255,255,0.3);
  padding: 8px 15px;
  border-radius: 20px;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 9px;
  transition: all 0.3s;
}

.filter-btn.active {
  background: rgba(0,255,255,0.2);
  color: #00e5ff;
  box-shadow: 0 0 10px rgba(0,255,255,0.5);
}

.filter-btn:hover {
  background: rgba(0,255,255,0.1);
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 25px;
  z-index: 1;
  position: relative;
}

.taskCard {
  background: rgba(27, 27, 27, 0.85);
  border-radius: 16px;
  box-shadow: 0 0 15px rgba(0,255,255,0.2);
  padding: 20px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: 200px;
  position: relative;
  transition: transform 0.3s, box-shadow 0.3s;
  overflow: hidden;
  backdrop-filter: blur(5px);
  border: 1px solid rgba(0, 255, 255, 0.1);
}

.taskCard::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #00e5ff, #ff00ff, #00e5ff);
  background-size: 200% 100%;
  animation: gradient-shift 3s linear infinite;
}

@keyframes gradient-shift {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.taskCard:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 0 25px rgba(0,255,255,0.4), 0 0 50px rgba(255,0,255,0.1);
  animation: glow 2s ease-in-out infinite;
}

.taskHeader { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start;
  margin-bottom: 10px;
}

.taskTitle { 
  font-size: 14px; 
  color: #00e5ff; 
  text-shadow: 0 0 6px #00e5ff;
  line-height: 1.4;
  flex: 1;
  margin-right: 10px;
}

.taskDesc { 
  font-size: 10px; 
  margin-top: 10px; 
  color: #a0fff0; 
  line-height: 1.5;
  flex-grow: 1;
}

.taskFooter { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-top: 15px; 
  font-size: 10px; 
}

.priorityLabel { 
  font-size: 9px; 
  font-weight: bold; 
  text-transform: uppercase;
  padding: 4px 8px;
  border-radius: 12px;
  background: rgba(0,0,0,0.3);
}

.urgent { border-left: 5px solid #ff1744; }
.daily { border-left: 5px solid #ff9100; }
.normal { border-left: 5px solid #00e676; }
.inprogress { border-left: 5px solid #2979ff; background: rgba(13, 71, 161, 0.7); }
.completed { border-left: 5px solid #00e676; background: rgba(0, 230, 118, 0.2); }

.urgent .priorityLabel { 
  color: #ff5252; 
  text-shadow: 0 0 6px #ff1744;
  background: rgba(255, 23, 68, 0.2);
}
.daily .priorityLabel { 
  color: #ffb74d; 
  text-shadow: 0 0 6px #ff9100;
  background: rgba(255, 145, 0, 0.2);
}
.normal .priorityLabel { 
  color: #00e676; 
  text-shadow: 0 0 6px #00e676;
  background: rgba(0, 230, 118, 0.2);
}
.inprogress .priorityLabel { 
  color: #82b1ff; 
  text-shadow: 0 0 6px #2979ff;
  background: rgba(41, 121, 255, 0.2);
}
.completed .priorityLabel { 
  color: #00e676; 
  text-shadow: 0 0 6px #00e676;
  background: rgba(0, 230, 118, 0.3);
}

.playerNameTag {
  font-size: 9px;
  color: #fff;
  background: rgba(0,0,0,0.3);
  padding: 4px 8px;
  border-radius: 12px;
  border: 1px solid rgba(0,255,255,0.4);
  text-shadow: 0 0 3px #00e5ff;
}

.countdown { 
  font-size: 10px; 
  margin-top: 10px; 
  color: #00fff7; 
  text-shadow: 0 0 3px #00fff7;
  background: rgba(0,0,0,0.3);
  padding: 5px 10px;
  border-radius: 12px;
  display: inline-block;
  width: fit-content;
}

.takeBtn, .completeBtn {
  background: linear-gradient(90deg, #00e5ff, #00ffcc);
  color: #000;
  font-size: 10px;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  transition: 0.3s;
  box-shadow: 0 0 10px #00e5ff, 0 0 20px #00ffcc;
  font-weight: bold;
  margin-top: 10px;
  align-self: flex-start;
}

.takeBtn:hover, .completeBtn:hover {
  background: linear-gradient(90deg, #00ffcc, #00e5ff);
  box-shadow: 0 0 25px #00fff7, 0 0 50px #00e5ff;
  animation: pulse 0.5s ease-in-out;
}

.moreBtn { 
  position: relative;
  cursor: pointer; 
  font-size: 16px;
  color: #a0fff0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.3s;
}

.moreBtn:hover {
  background: rgba(160, 255, 240, 0.1);
}

.moreMenu {
  position: absolute;
  top: 30px; 
  right: 0;
  background: rgba(66, 66, 66, 0.95);
  display: none; 
  flex-direction: column;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  z-index: 10;
  min-width: 150px;
  backdrop-filter: blur(5px);
  border: 1px solid rgba(0, 255, 255, 0.2);
}

.moreMenu button {
  font-size: 10px; 
  padding: 8px 12px; 
  background: transparent; 
  color: #fff;
  border: none; 
  cursor: pointer;
  text-align: left;
  transition: background 0.2s;
}

.moreMenu button:hover { 
  background: rgba(0, 255, 255, 0.2); 
}

.moreMenu button i {
  margin-right: 8px;
  width: 12px;
}

#addTaskBtn {
  position: fixed;
  bottom: 30px; 
  right: 30px;
  background: #00fff7;
  color: #000;
  border: none;
  width: 60px; 
  height: 60px;
  font-size: 24px;
  border-radius: 50%;
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 0 20px #00fff7;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: pulse 2s infinite;
}

#addTaskBtn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 30px #00fff7, 0 0 50px #00e5ff;
}

#addTaskPanel {
  position: fixed;
  bottom: 100px; 
  right: 30px;
  background: rgba(0,0,0,0.95);
  padding: 20px;
  border-radius: 16px;
  display: none;
  flex-direction: column;
  gap: 15px;
  z-index: 99;
  width: 300px;
  box-shadow: 0 0 30px rgba(0,255,255,0.3);
  border: 1px solid rgba(0,255,255,0.2);
  backdrop-filter: blur(10px);
}

#addTaskPanel h3 {
  margin: 0 0 10px 0;
  color: #00e5ff;
  font-size: 14px;
  text-align: center;
}

#addTaskPanel input, #addTaskPanel select, #addTaskPanel textarea, #addTaskPanel button {
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}

#addTaskPanel input, #addTaskPanel select, #addTaskPanel textarea {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid rgba(0,255,255,0.3);
  background: rgba(18, 18, 18, 0.8);
  color: #00fff7;
  transition: border 0.3s;
}

#addTaskPanel input:focus, #addTaskPanel select:focus, #addTaskPanel textarea:focus {
  outline: none;
  border: 1px solid #00fff7;
  box-shadow: 0 0 10px rgba(0,255,255,0.5);
}

#addTaskPanel button {
  background: linear-gradient(90deg, #00e5ff, #00ffcc);
  color: #000;
  border: none;
  cursor: pointer;
  padding: 10px;
  border-radius: 8px;
  font-weight: bold;
  transition: all 0.3s;
}

#addTaskPanel button:hover {
  background: linear-gradient(90deg, #00ffcc, #00e5ff);
  box-shadow: 0 0 15px rgba(0,255,255,0.7);
}

#takeModal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  display: none; 
  justify-content: center; 
  align-items: center;
  z-index: 200;
  backdrop-filter: blur(5px);
}

#modalContent {
  background: rgba(33, 33, 33, 0.95);
  padding: 30px;
  border-radius: 16px;
  min-width: 300px;
  display: flex; 
  flex-direction: column; 
  gap: 15px;
  box-shadow: 0 0 40px rgba(0,255,255,0.3);
  border: 1px solid rgba(0,255,255,0.2);
  backdrop-filter: blur(10px);
}

#modalTitle {
  font-size: 16px;
  color: #00e5ff;
  text-align: center;
  margin-bottom: 10px;
}

#playerName {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid rgba(0,255,255,0.3);
  background: rgba(18, 18, 18, 0.8);
  color: #00fff7;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}

#playerName:focus {
  outline: none;
  border: 1px solid #00fff7;
  box-shadow: 0 0 10px rgba(0,255,255,0.5);
}

#takeConfirm, #takeCancel {
  padding: 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  transition: all 0.3s;
}

#takeConfirm {
  background: linear-gradient(90deg, #00e5ff, #00ffcc);
  color: #000;
  font-weight: bold;
}

#takeConfirm:hover {
  background: linear-gradient(90deg, #00ffcc, #00e5ff);
  box-shadow: 0 0 15px rgba(0,255,255,0.7);
}

#takeCancel {
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

#takeCancel:hover {
  background: rgba(255, 255, 255, 0.2);
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #a0fff0;
  grid-column: 1 / -1;
}

.empty-state i {
  font-size: 40px;
  margin-bottom: 20px;
  color: rgba(0,255,255,0.3);
}

.empty-state p {
  font-size: 12px;
  line-height: 1.6;
}

.completed-section {
  display: none;
}

.player-filter {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.player-filter select {
  background: rgba(27, 27, 27, 0.7);
  color: #a0fff0;
  border: 1px solid rgba(0,255,255,0.3);
  padding: 8px 15px;
  border-radius: 8px;
  font-family: 'Press Start 2P', cursive;
  font-size: 9px;
}

@media (max-width: 768px) {
  .container {
    grid-template-columns: 1fr;
    padding: 10px;
  }
  
  h1 {
    font-size: 20px;
  }
  
  #addTaskPanel {
    width: calc(100% - 40px);
    right: 20px;
    left: 20px;
    bottom: 100px;
  }
  
  .tabs {
    flex-direction: column;
    align-items: center;
  }
  
  .tab-btn {
    width: 80%;
  }
}
</style>
</head>
<body>
<header>
  <h1>Доска заданий</h1>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="active">Активные задания</button>
  <button class="tab-btn" data-tab="completed">Выполненные задания</button>
</div>

<div class="active-section">
  <div class="filter-bar">
    <button class="filter-btn active" data-filter="all">Все задания</button>
    <button class="filter-btn" data-filter="urgent">Срочные</button>
    <button class="filter-btn" data-filter="daily">Ежедневные</button>
    <button class="filter-btn" data-filter="normal">Обычные</button>
    <button class="filter-btn" data-filter="inprogress">В процессе</button>
  </div>

  <div class="container" id="tasksBoard">
  </div>
</div>

<div class="completed-section">
  <div class="player-filter">
    <select id="playerFilter">
      <option value="all">Все игроки</option>
    </select>
  </div>

  <div class="container" id="completedTasksBoard">
  </div>
</div>

<button id="addTaskBtn">
  <i class="fas fa-plus"></i>
</button>

<div id="addTaskPanel">
  <h3>Добавить новое задание</h3>
  <input type="text" id="taskTitle" placeholder="Название задания">
  <textarea id="taskDesc" placeholder="Описание (необязательно)" rows="3"></textarea>
  <input type="datetime-local" id="taskDeadline">
  <select id="taskCategory">
    <option value="urgent">Срочные</option>
    <option value="daily">Ежедневные</option>
    <option value="normal">Не срочные</option>
  </select>
  <button id="submitTask">Добавить задание</button>
</div>

<div id="takeModal">
  <div id="modalContent">
    <div id="modalTitle"></div>
    <input type="text" id="playerName" placeholder="Введите ваш ник">
    <button id="takeConfirm">Взять задание</button>
    <button id="takeCancel">Отмена</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAb1xT6mIHlxcZNt1TBS7jrrDp5re3qMOU",
  authDomain: "klan-d9201.firebaseapp.com",
  databaseURL: "https://klan-d9201-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "klan-d9201",
  storageBucket: "klan-d9201.appspot.com",
  messagingSenderId: "252485302766",
  appId: "1:252485302766:web:7f60cca53e9c9b2d38f6ff"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const addBtn = document.getElementById('addTaskBtn');
const addPanel = document.getElementById('addTaskPanel');
const submitTask = document.getElementById('submitTask');
const taskTitle = document.getElementById('taskTitle');
const taskDesc = document.getElementById('taskDesc');
const taskCategory = document.getElementById('taskCategory');
const taskDeadline = document.getElementById('taskDeadline');
const tasksBoard = document.getElementById('tasksBoard');
const completedTasksBoard = document.getElementById('completedTasksBoard');
const filterBtns = document.querySelectorAll('.filter-btn');
const tabBtns = document.querySelectorAll('.tab-btn');
const playerFilter = document.getElementById('playerFilter');
const activeSection = document.querySelector('.active-section');
const completedSection = document.querySelector('.completed-section');

const takeModal = document.getElementById('takeModal');
const modalTitle = document.getElementById('modalTitle');
const playerNameInput = document.getElementById('playerName');
const takeConfirm = document.getElementById('takeConfirm');
const takeCancel = document.getElementById('takeCancel');
let currentTaskId = null;
let currentFilter = 'all';
let currentTab = 'active';

tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    tabBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentTab = btn.dataset.tab;
    
    if (currentTab === 'active') {
      activeSection.style.display = 'block';
      completedSection.style.display = 'none';
    } else {
      activeSection.style.display = 'none';
      completedSection.style.display = 'block';
      renderCompletedTasksFromSnapshot(lastSnapshot);
    }
  });
});

addBtn.onclick = () => addPanel.style.display = addPanel.style.display === 'flex' ? 'none' : 'flex';

filterBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    filterBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderTasksFromSnapshot(lastSnapshot);
  });
});

submitTask.onclick = () => {
  const title = taskTitle.value.trim();
  if (!title) return alert('Название задания обязательно!');
  const desc = taskDesc.value.trim();
  const category = taskCategory.value;
  const deadline = taskDeadline.value ? new Date(taskDeadline.value).getTime() : null;
  push(ref(db, 'tasks'), { title, desc, category, deadline, status: 'new' });
  taskTitle.value = ''; taskDesc.value = ''; taskDeadline.value = '';
  addPanel.style.display = 'none';
};

function createTaskCard(id, data) {
  const card = document.createElement('div');
  card.className = `taskCard ${data.status === 'inprogress' ? 'inprogress' : data.status === 'completed' ? 'completed' : data.category}`;
  card.dataset.category = data.status === 'inprogress' ? 'inprogress' : data.status === 'completed' ? 'completed' : data.category;

  const header = document.createElement('div');
  header.className='taskHeader';
  const titleEl = document.createElement('div');
  titleEl.className='taskTitle';
  titleEl.textContent = data.title;

  const moreBtn = document.createElement('div');
  moreBtn.className='moreBtn';
  moreBtn.innerHTML='<i class="fas fa-ellipsis-v"></i>';

  const moreMenu = document.createElement('div');
  moreMenu.className='moreMenu';

  const editBtn = document.createElement('button');
  editBtn.innerHTML='<i class="fas fa-edit"></i> Редактировать';
  const delBtn = document.createElement('button');
  delBtn.innerHTML='<i class="fas fa-trash"></i> Удалить';
  moreMenu.append(editBtn, delBtn);
  
  moreBtn.onclick = (e) => {
    e.stopPropagation();
    moreMenu.style.display = moreMenu.style.display==='flex'?'none':'flex';
  };
  
  editBtn.onclick = ()=> {
    const newTitle = prompt('Новое название', data.title);
    if(newTitle) update(ref(db,'tasks/'+id),{title:newTitle});
    moreMenu.style.display = 'none';
  };
  
  delBtn.onclick = ()=> {
    if(confirm('Вы уверены, что хотите удалить это задание?')) {
      remove(ref(db,'tasks/'+id));
    }
    moreMenu.style.display = 'none';
  };
  
  document.addEventListener('click', (e) => {
    if (!moreMenu.contains(e.target) && !moreBtn.contains(e.target)) {
      moreMenu.style.display = 'none';
    }
  });
  
  header.append(titleEl, moreBtn, moreMenu);

  const descEl = document.createElement('div');
  descEl.className='taskDesc';
  descEl.textContent=data.desc || '';

  const footer = document.createElement('div');
  footer.className='taskFooter';
  const priorityLabel = document.createElement('div');
  priorityLabel.className='priorityLabel';
  
  if (data.status === 'inprogress') {
    priorityLabel.textContent = 'В процессе';
    const playerTag = document.createElement('div');
    playerTag.className='playerNameTag';
    playerTag.textContent = data.player || '???';
    footer.append(priorityLabel, playerTag);
  } else if (data.status === 'completed') {
    priorityLabel.textContent = 'Выполнено';
    const playerTag = document.createElement('div');
    playerTag.className='playerNameTag';
    playerTag.textContent = data.player || '???';
    const completedDate = document.createElement('div');
    completedDate.className='countdown';
    completedDate.textContent = `Выполнено: ${new Date(data.completedAt).toLocaleDateString()}`;
    footer.append(priorityLabel, playerTag);
    card.append(completedDate);
  } else {
    priorityLabel.textContent = data.category==='urgent'?'Срочное':data.category==='daily'?'Ежедневное':'Обычное';
    footer.append(priorityLabel);
  }

  card.append(header, descEl);

  if(data.deadline && data.status !== 'completed'){
    const countdown = document.createElement('div');
    countdown.className='countdown';
    card.append(countdown);
    
    const updateCountdown = () => {
      const now=Date.now();
      const diff=Math.max(0, data.deadline-now);
      const d=Math.floor(diff/86400000);
      const h=Math.floor((diff%86400000)/3600000);
      const m=Math.floor((diff%3600000)/60000);
      const s=Math.floor((diff%60000)/1000);
      countdown.textContent=`⏱️ ${d}д ${h}ч ${m}м ${s}с`;
    };
    
    updateCountdown();
    const countdownInterval = setInterval(updateCountdown, 1000);
    
    card.dataset.countdownInterval = countdownInterval;
  }

  if (data.status === 'new') {
    const takeBtn = document.createElement('button');
    takeBtn.className='takeBtn';
    takeBtn.innerHTML='<i class="fas fa-hand-paper"></i> Взять задание';
    takeBtn.onclick = ()=> {
      currentTaskId = id;
      modalTitle.textContent = data.title;
      playerNameInput.value='';
      takeModal.style.display='flex';
    };
    card.append(takeBtn);
  } else if (data.status === 'inprogress') {
    const completeBtn = document.createElement('button');
    completeBtn.className='completeBtn';
    completeBtn.innerHTML='<i class="fas fa-check"></i> Задание выполнено';
    completeBtn.onclick = () => {
      card.style.animation = 'flyAway 1s forwards';
      
      setTimeout(() => {
        update(ref(db, 'tasks/' + id), {
          status: 'completed',
          completedAt: Date.now()
        });
      }, 1000);
    };
    card.append(completeBtn);
  }

  card.append(footer);
  return card;
}

let lastSnapshot = null;

function renderTasksFromSnapshot(snapshot){
  if (!snapshot) return;
  
  tasksBoard.innerHTML='';
  const tasks = [];
  snapshot.forEach(s=>{
    const taskData = s.val();
    if (taskData.status !== 'completed') {
      tasks.push({id:s.key, data:taskData});
    }
  });
  
  const filteredTasks = tasks.filter(task => {
    if (currentFilter === 'all') return true;
    if (currentFilter === 'inprogress') return task.data.status === 'inprogress';
    return task.data.category === currentFilter && task.data.status !== 'inprogress';
  });
  
  if (filteredTasks.length === 0) {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    emptyState.innerHTML = `
      <i class="fas fa-tasks"></i>
      <p>Нет заданий для отображения</p>
      <p>Создайте новое задание, нажав на кнопку "+"</p>
    `;
    tasksBoard.append(emptyState);
    return;
  }
  
  const prio={'urgent':4,'daily':3,'normal':2,'inprogress':1};
  filteredTasks.sort((a,b)=> (prio[b.data.category]||0)-(prio[a.data.category]||0));
  filteredTasks.forEach(t=>tasksBoard.append(createTaskCard(t.id,t.data)));
}

function renderCompletedTasksFromSnapshot(snapshot) {
  if (!snapshot) return;
  
  completedTasksBoard.innerHTML='';
  const tasks = [];
  const players = new Set();
  
  snapshot.forEach(s=>{
    const taskData = s.val();
    if (taskData.status === 'completed') {
      tasks.push({id:s.key, data:taskData});
      if (taskData.player) {
        players.add(taskData.player);
      }
    }
  });
  
  updatePlayerFilter(players);
  
  const selectedPlayer = playerFilter.value;
  const filteredTasks = selectedPlayer === 'all' 
    ? tasks 
    : tasks.filter(task => task.data.player === selectedPlayer);
  
  if (filteredTasks.length === 0) {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    emptyState.innerHTML = `
      <i class="fas fa-check-circle"></i>
      <p>Нет выполненных заданий</p>
      <p>Выполненные задания появятся здесь</p>
    `;
    completedTasksBoard.append(emptyState);
    return;
  }
  
  filteredTasks.sort((a, b) => (b.data.completedAt || 0) - (a.data.completedAt || 0));
  filteredTasks.forEach(t => completedTasksBoard.append(createTaskCard(t.id, t.data)));
}

function updatePlayerFilter(players) {
  const currentValue = playerFilter.value;
  
  playerFilter.innerHTML = '<option value="all">Все игроки</option>';
  
  const sortedPlayers = Array.from(players).sort();
  sortedPlayers.forEach(player => {
    const option = document.createElement('option');
    option.value = player;
    option.textContent = player;
    playerFilter.appendChild(option);
  });
  
  if (sortedPlayers.includes(currentValue)) {
    playerFilter.value = currentValue;
  }
}

function renderTasks(snapshot){
  lastSnapshot = snapshot;
  
  if (currentTab === 'active') {
    renderTasksFromSnapshot(snapshot);
  } else {
    renderCompletedTasksFromSnapshot(snapshot);
  }
}

onValue(ref(db,'tasks'), renderTasks);

playerFilter.addEventListener('change', () => {
  renderCompletedTasksFromSnapshot(lastSnapshot);
});

takeConfirm.onclick = ()=>{
  const name = playerNameInput.value.trim();
  if(!name) return alert('Введите ник!');
  update(ref(db,'tasks/'+currentTaskId),{status:'inprogress',player:name});
  takeModal.style.display='none';
};

takeCancel.onclick = ()=>takeModal.style.display='none';

takeModal.addEventListener('click', (e) => {
  if (e.target === takeModal) {
    takeModal.style.display = 'none';
  }
});

document.addEventListener('click', (e) => {
  if (!addPanel.contains(e.target) && e.target !== addBtn) {
    addPanel.style.display = 'none';
  }
});
</script>
</body>
</html>