<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Доска заданий</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@keyframes lightOn {
  0% { opacity: 0; transform: scale(0.8); }
  100% { opacity: 1; transform: scale(1); }
}

@keyframes bulbGlow {
  0%, 100% { 
    filter: drop-shadow(0 0 5px #ffeb3b) drop-shadow(0 0 20px #ff9800);
    transform: scale(1) rotate(0deg);
  }
  25% { 
    filter: drop-shadow(0 0 15px #ffeb3b) drop-shadow(0 0 40px #ff9800) drop-shadow(0 0 60px #ff5722);
    transform: scale(1.05) rotate(2deg);
  }
  50% { 
    filter: drop-shadow(0 0 20px #ffeb3b) drop-shadow(0 0 50px #ff9800) drop-shadow(0 0 80px #ff5722);
    transform: scale(1.08) rotate(0deg);
  }
  75% { 
    filter: drop-shadow(0 0 15px #ffeb3b) drop-shadow(0 0 40px #ff9800) drop-shadow(0 0 60px #ff5722);
    transform: scale(1.05) rotate(-2deg);
  }
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  33% { transform: translateY(-15px) rotate(1deg); }
  66% { transform: translateY(-8px) rotate(-1deg); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.08); }
}

@keyframes flyAway {
  0% { transform: translateX(0) scale(1); opacity: 1; }
  50% { transform: translateX(100px) scale(0.8); opacity: 0.7; }
  100% { transform: translateX(1000px) scale(0.5); opacity: 0; }
}

@keyframes sparkle {
  0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
  50% { opacity: 1; transform: scale(1) rotate(180deg); }
}

@keyframes blockFloat {
  0%, 100% { transform: translateY(0) rotateX(0deg); }
  50% { transform: translateY(-5px) rotateX(5deg); }
}

@keyframes glowPulse {
  0%, 100% { box-shadow: 0 0 20px rgba(255,235,59,0.3); }
  50% { box-shadow: 0 0 40px rgba(255,235,59,0.6), 0 0 80px rgba(255,152,0,0.3); }
}

@keyframes textShine {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}

body {
  margin: 0;
  font-family: 'Press Start 2P', cursive;
  background: #000;
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}

.mc-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('https://github.com/kstrahov333-tech/klan/blob/main/blackstone.png?raw=true');
  background-size: 200px 200px;
  image-rendering: pixelated;
  image-rendering: -moz-crisp-edges;
  image-rendering: crisp-edges;
  opacity: 0.4;
  z-index: -2;
  animation: blockFloat 8s ease-in-out infinite;
}

.mc-background::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    repeating-linear-gradient(
      90deg,
      transparent,
      transparent 199px,
      rgba(255,235,59,0.05) 200px,
      rgba(255,235,59,0.05) 201px
    ),
    repeating-linear-gradient(
      180deg,
      transparent,
      transparent 199px,
      rgba(255,235,59,0.05) 200px,
      rgba(255,235,59,0.05) 201px
    );
  pointer-events: none;
}

.light-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(
      circle at 50% 10%,
      rgba(255,235,59,0.25) 0%,
      rgba(255,152,0,0.15) 20%,
      rgba(255,87,34,0.08) 40%,
      transparent 70%
    ),
    radial-gradient(
      circle at 80% 90%,
      rgba(255,193,7,0.1) 0%,
      rgba(255,152,0,0.05) 30%,
      transparent 60%
    ),
    radial-gradient(
      circle at 20% 70%,
      rgba(255,235,59,0.08) 0%,
      rgba(255,152,0,0.03) 25%,
      transparent 50%
    );
  pointer-events: none;
  z-index: -1;
  animation: lightOn 3s ease-out;
}

.sparkles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: -1;
}

.sparkle {
  position: absolute;
  width: 4px;
  height: 4px;
  background: #ffeb3b;
  border-radius: 50%;
  animation: sparkle 3s ease-in-out infinite;
}

.bulb-container {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1;
  animation: bulbGlow 4s ease-in-out infinite, float 8s ease-in-out infinite;
  filter: drop-shadow(0 0 10px #ffeb3b);
}

.bulb {
  font-size: 48px;
  color: #ffeb3b;
  text-shadow: 
    0 0 20px #ff9800, 
    0 0 40px #ff5722,
    0 0 80px #ff5722;
  transition: all 0.3s ease;
}

.bulb:hover {
  transform: scale(1.2) rotate(10deg);
}

header {
  text-align: center;
  padding: 100px 0 30px 0;
  position: relative;
  z-index: 1;
}

h1 {
  font-size: 32px;
  background: linear-gradient(
    90deg,
    #ffeb3b,
    #ffd54f,
    #ffb300,
    #ffd54f,
    #ffeb3b
  );
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: textShine 3s linear infinite;
  margin-bottom: 20px;
  text-shadow: 0 0 30px rgba(255,235,59,0.5);
  position: relative;
}

h1::after {
  content: "";
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 100px;
  height: 3px;
  background: linear-gradient(90deg, transparent, #ffeb3b, transparent);
  animation: glowPulse 2s ease-in-out infinite;
}

.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 30px;
  gap: 15px;
  flex-wrap: wrap;
  position: relative;
  z-index: 1;
}

.tab-btn {
  background: rgba(20, 20, 20, 0.95);
  color: #ffd54f;
  border: 2px solid rgba(255, 235, 59, 0.4);
  padding: 12px 24px;
  border-radius: 12px;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
}

.tab-btn::before {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,235,59,0.2), transparent);
  transition: left 0.6s;
}

.tab-btn:hover::before {
  left: 100%;
}

.tab-btn.active {
  background: rgba(255, 235, 59, 0.15);
  color: #ffeb3b;
  box-shadow: 
    0 0 20px rgba(255,235,59,0.4),
    inset 0 0 20px rgba(255,235,59,0.1);
  border-color: #ffeb3b;
  transform: translateY(-2px);
}

.tab-btn:hover {
  background: rgba(255, 235, 59, 0.1);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255,235,59,0.2);
}

.filter-bar {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 30px;
  flex-wrap: wrap;
  position: relative;
  z-index: 1;
}

.filter-btn {
  background: rgba(30, 30, 30, 0.95);
  color: #ffd54f;
  border: 1px solid rgba(255, 235, 59, 0.3);
  padding: 10px 18px;
  border-radius: 25px;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 9px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.filter-btn::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 2px;
  background: #ffeb3b;
  transition: all 0.3s ease;
  transform: translateX(-50%);
}

.filter-btn.active {
  background: rgba(255, 235, 59, 0.2);
  color: #ffeb3b;
  box-shadow: 0 0 15px rgba(255,235,59,0.3);
}

.filter-btn.active::after {
  width: 80%;
}

.filter-btn:hover {
  background: rgba(255, 235, 59, 0.15);
  transform: translateY(-1px);
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 25px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 30px;
  position: relative;
  z-index: 1;
}

.taskCard {
  background: rgba(25, 25, 25, 0.92);
  border-radius: 20px;
  box-shadow: 
    0 8px 32px rgba(0,0,0,0.3),
    0 0 20px rgba(255,235,59,0.1);
  padding: 25px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: 220px;
  position: relative;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  overflow: hidden;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 235, 59, 0.15);
  animation: glowPulse 4s ease-in-out infinite;
}

.taskCard::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #ffeb3b, #ff9800, #ff5722, #ff9800, #ffeb3b);
  background-size: 200% 100%;
  animation: gradient-shift 3s linear infinite;
}

.taskCard::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 50%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,235,59,0.1), transparent);
  transition: left 0.6s;
}

.taskCard:hover::after {
  left: 100%;
}

@keyframes gradient-shift {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.taskCard:hover {
  transform: translateY(-10px) scale(1.02);
  box-shadow: 
    0 15px 40px rgba(255,235,59,0.25),
    0 0 30px rgba(255,152,0,0.2),
    inset 0 0 30px rgba(255,235,59,0.05);
}

.taskHeader { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start;
  margin-bottom: 15px;
}

.taskTitle { 
  font-size: 15px; 
  color: #ffeb3b; 
  text-shadow: 0 0 10px rgba(255,152,0,0.5);
  line-height: 1.4;
  flex: 1;
  margin-right: 15px;
}

.taskDesc { 
  font-size: 10px; 
  margin-top: 12px; 
  color: #ffd54f; 
  line-height: 1.6;
  flex-grow: 1;
  opacity: 0.9;
}

.taskFooter { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-top: 20px; 
  font-size: 10px; 
}

.priorityLabel { 
  font-size: 9px; 
  font-weight: bold; 
  text-transform: uppercase;
  padding: 6px 12px;
  border-radius: 15px;
  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(255,235,59,0.3);
}

.urgent { border-left: 6px solid #ff5252; }
.daily { border-left: 6px solid #ffb74d; }
.normal { border-left: 6px solid #ffd54f; }
.inprogress { border-left: 6px solid #ff9800; background: rgba(255, 152, 0, 0.15); }
.completed { border-left: 6px solid #ffd54f; background: rgba(255, 213, 79, 0.15); }

.urgent .priorityLabel { 
  color: #ff5252; 
  text-shadow: 0 0 8px #ff1744;
  background: rgba(255, 23, 68, 0.25);
  border-color: rgba(255, 82, 82, 0.5);
}
.daily .priorityLabel { 
  color: #ffb74d; 
  text-shadow: 0 0 8px #ff9100;
  background: rgba(255, 145, 0, 0.25);
  border-color: rgba(255, 183, 77, 0.5);
}
.normal .priorityLabel { 
  color: #ffd54f; 
  text-shadow: 0 0 8px #ffd54f;
  background: rgba(255, 213, 79, 0.25);
  border-color: rgba(255, 213, 79, 0.5);
}
.inprogress .priorityLabel { 
  color: #ffb74d; 
  text-shadow: 0 0 8px #ff9800;
  background: rgba(255, 152, 0, 0.25);
  border-color: rgba(255, 152, 0, 0.5);
}
.completed .priorityLabel { 
  color: #ffd54f; 
  text-shadow: 0 0 8px #ffd54f;
  background: rgba(255, 213, 79, 0.3);
  border-color: rgba(255, 213, 79, 0.6);
}

.playerNameTag {
  font-size: 9px;
  color: #fff;
  background: rgba(0,0,0,0.4);
  padding: 5px 10px;
  border-radius: 15px;
  border: 1px solid rgba(255, 235, 59, 0.5);
  text-shadow: 0 0 5px #ffeb3b;
}

.countdown { 
  font-size: 10px; 
  margin-top: 12px; 
  color: #ffeb3b; 
  text-shadow: 0 0 5px #ff9800;
  background: rgba(0,0,0,0.4);
  padding: 6px 12px;
  border-radius: 15px;
  display: inline-block;
  width: fit-content;
  border: 1px solid rgba(255,235,59,0.3);
  animation: glowPulse 2s ease-in-out infinite;
}

.takeBtn, .completeBtn, .useTemplateBtn, .usePackBtn {
  background: linear-gradient(135deg, #ffeb3b, #ffd54f);
  color: #000;
  font-size: 10px;
  border: none;
  border-radius: 12px;
  padding: 10px 16px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 
    0 4px 15px rgba(255,235,59,0.3),
    0 0 20px rgba(255,235,59,0.2);
  font-weight: bold;
  margin-top: 12px;
  align-self: flex-start;
  position: relative;
  overflow: hidden;
}

.takeBtn::before, .completeBtn::before, .useTemplateBtn::before, .usePackBtn::before {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  transition: left 0.5s;
}

.takeBtn:hover::before, .completeBtn:hover::before, .useTemplateBtn:hover::before, .usePackBtn:hover::before {
  left: 100%;
}

.takeBtn:hover, .completeBtn:hover, .useTemplateBtn:hover, .usePackBtn:hover {
  background: linear-gradient(135deg, #ffd54f, #ffeb3b);
  box-shadow: 
    0 6px 20px rgba(255,235,59,0.5),
    0 0 30px rgba(255,235,59,0.4);
  transform: translateY(-2px) scale(1.05);
  animation: pulse 0.5s ease-in-out;
}

.moreBtn { 
  position: relative;
  cursor: pointer; 
  font-size: 16px;
  color: #ffd54f;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.3s ease;
  border: 1px solid rgba(255,235,59,0.3);
}

.moreBtn:hover {
  background: rgba(255, 213, 79, 0.15);
  transform: rotate(90deg);
  box-shadow: 0 0 10px rgba(255,235,59,0.3);
}

.moreMenu {
  position: absolute;
  top: 35px; 
  right: 0;
  background: rgba(40, 40, 40, 0.98);
  display: none; 
  flex-direction: column;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 
    0 10px 30px rgba(0,0,0,0.5),
    0 0 20px rgba(255,235,59,0.2);
  z-index: 10;
  min-width: 180px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 235, 59, 0.3);
  animation: lightOn 0.3s ease-out;
}

.moreMenu button {
  font-size: 10px; 
  padding: 10px 15px; 
  background: transparent; 
  color: #fff;
  border: none; 
  cursor: pointer;
  text-align: left;
  transition: all 0.2s ease;
  border-bottom: 1px solid rgba(255,235,59,0.1);
}

.moreMenu button:last-child {
  border-bottom: none;
}

.moreMenu button:hover { 
  background: rgba(255, 235, 59, 0.15); 
  padding-left: 20px;
}

.moreMenu button i {
  margin-right: 10px;
  width: 12px;
  color: #ffd54f;
}

#addTaskBtn {
  position: fixed;
  bottom: 40px; 
  right: 40px;
  background: linear-gradient(135deg, #ffeb3b, #ffb300);
  color: #000;
  border: none;
  width: 70px; 
  height: 70px;
  font-size: 28px;
  border-radius: 50%;
  cursor: pointer;
  z-index: 100;
  box-shadow: 
    0 8px 25px rgba(255,235,59,0.4),
    0 0 30px rgba(255,235,59,0.3);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: 
    pulse 2s infinite,
    bulbGlow 3s ease-in-out infinite,
    float 6s ease-in-out infinite;
  pointer-events: auto;
}

#addTaskBtn:hover {
  transform: scale(1.15) rotate(15deg);
  box-shadow: 
    0 12px 35px rgba(255,235,59,0.6),
    0 0 50px rgba(255,235,59,0.5),
    0 0 70px rgba(255,152,0,0.3);
}

#addTaskPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.95);
  padding: 25px;
  border-radius: 20px;
  display: none;
  flex-direction: column;
  gap: 18px;
  z-index: 99;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 
    0 15px 40px rgba(255,235,59,0.25),
    0 0 40px rgba(255,152,0,0.2);
  border: 1px solid rgba(255,235,59,0.25);
  backdrop-filter: blur(15px);
  animation: lightOn 0.4s ease-out;
}

.panel-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.panel-tab {
  flex: 1;
  padding: 8px 12px;
  background: rgba(30, 30, 30, 0.8);
  border: 1px solid rgba(255,235,59,0.3);
  border-radius: 8px;
  color: #ffd54f;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 8px;
  transition: all 0.3s ease;
  text-align: center;
  min-width: 120px;
}

.panel-tab.active {
  background: rgba(255,235,59,0.2);
  color: #ffeb3b;
  border-color: #ffeb3b;
  box-shadow: 0 0 10px rgba(255,235,59,0.3);
}

.panel-tab:hover {
  background: rgba(255,235,59,0.15);
}

.panel-content {
  display: none;
}

.panel-content.active {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

#addTaskPanel h3 {
  margin: 0 0 15px 0;
  color: #ffeb3b;
  font-size: 14px;
  text-align: center;
  text-shadow: 0 0 10px rgba(255,152,0,0.5);
}

#addTaskPanel input, #addTaskPanel select, #addTaskPanel textarea, #addTaskPanel button {
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}

#addTaskPanel input, #addTaskPanel select, #addTaskPanel textarea {
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,235,59,0.4);
  background: rgba(30, 30, 30, 0.9);
  color: #ffeb3b;
  transition: all 0.3s ease;
}

#addTaskPanel input:focus, #addTaskPanel select:focus, #addTaskPanel textarea:focus {
  outline: none;
  border: 1px solid #ffeb3b;
  box-shadow: 
    0 0 15px rgba(255,235,59,0.4),
    inset 0 0 10px rgba(255,235,59,0.1);
  transform: translateY(-1px);
}

#addTaskPanel button {
  background: linear-gradient(135deg, #ffeb3b, #ffd54f);
  color: #000;
  border: none;
  cursor: pointer;
  padding: 12px;
  border-radius: 10px;
  font-weight: bold;
  transition: all 0.3s ease;
  margin-top: 10px;
}

#addTaskPanel button:hover {
  background: linear-gradient(135deg, #ffd54f, #ffeb3b);
  box-shadow: 
    0 5px 20px rgba(255,235,59,0.5),
    0 0 25px rgba(255,235,59,0.3);
  transform: translateY(-2px);
}

.templates-list, .packs-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid rgba(255,235,59,0.3);
  border-radius: 10px;
  padding: 10px;
  background: rgba(30, 30, 30, 0.8);
}

.template-item, .pack-item {
  padding: 10px;
  border-bottom: 1px solid rgba(255,235,59,0.2);
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.template-item:last-child, .pack-item:last-child {
  border-bottom: none;
}

.template-item:hover, .pack-item:hover {
  background: rgba(255,235,59,0.1);
  transform: translateX(5px);
}

.template-info, .pack-info {
  flex: 1;
  min-width: 0;
}

.template-title, .pack-title {
  font-size: 10px;
  color: #ffeb3b;
  margin-bottom: 5px;
  word-break: break-word;
}

.template-desc, .pack-desc {
  font-size: 8px;
  color: #ffd54f;
  opacity: 0.8;
  word-break: break-word;
}

.template-actions, .pack-actions {
  display: flex;
  gap: 5px;
  flex-shrink: 0;
}

.template-action-btn, .pack-action-btn {
  background: none;
  border: none;
  color: #ffd54f;
  cursor: pointer;
  padding: 5px;
  border-radius: 5px;
  transition: all 0.3s ease;
  font-size: 9px;
  flex-shrink: 0;
}

.template-action-btn:hover, .pack-action-btn:hover {
  background: rgba(255,235,59,0.2);
  color: #ffeb3b;
}

.datetime-inputs {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.datetime-row {
  display: flex;
  gap: 12px;
  align-items: center;
}

.datetime-row input {
  flex: 1;
}

.datetime-row span {
  font-size: 10px;
  color: #ffd54f;
  white-space: nowrap;
}

.template-deadline, .pack-templates {
  margin-top: 10px;
  padding: 10px;
  background: rgba(255,235,59,0.05);
  border-radius: 8px;
  border: 1px solid rgba(255,235,59,0.2);
}

.template-list {
  max-height: 100px;
  overflow-y: auto;
  margin-top: 8px;
  padding: 5px;
  background: rgba(0,0,0,0.3);
  border-radius: 5px;
}

.template-list-item {
  font-size: 8px;
  padding: 3px 5px;
  border-bottom: 1px solid rgba(255,235,59,0.1);
  color: #ffd54f;
  display: flex;
  align-items: center;
  gap: 5px;
}

.template-list-item:last-child {
  border-bottom: none;
}

#takeModal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.95);
  display: none; 
  justify-content: center; 
  align-items: center;
  z-index: 200;
  backdrop-filter: blur(10px);
  animation: lightOn 0.3s ease-out;
}

#modalContent {
  background: rgba(25, 25, 25, 0.95);
  padding: 35px;
  border-radius: 20px;
  min-width: 350px;
  display: flex; 
  flex-direction: column; 
  gap: 18px;
  box-shadow: 
    0 20px 50px rgba(255,235,59,0.25),
    0 0 60px rgba(255,152,0,0.2);
  border: 1px solid rgba(255,235,59,0.3);
  backdrop-filter: blur(20px);
  animation: glowPulse 3s ease-in-out infinite;
}

#modalTitle {
  font-size: 16px;
  color: #ffeb3b;
  text-align: center;
  margin-bottom: 15px;
  text-shadow: 0 0 10px rgba(255,152,0,0.5);
}

#playerName {
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,235,59,0.4);
  background: rgba(30, 30, 30, 0.9);
  color: #ffeb3b;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  transition: all 0.3s ease;
}

#playerName:focus {
  outline: none;
  border: 1px solid #ffeb3b;
  box-shadow: 
    0 0 15px rgba(255,235,59,0.4),
    inset 0 0 10px rgba(255,235,59,0.1);
  transform: translateY(-1px);
}

#takeConfirm, #takeCancel {
  padding: 12px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  transition: all 0.3s ease;
}

#takeConfirm {
  background: linear-gradient(135deg, #ffeb3b, #ffd54f);
  color: #000;
  font-weight: bold;
}

#takeConfirm:hover {
  background: linear-gradient(135deg, #ffd54f, #ffeb3b);
  box-shadow: 
    0 5px 20px rgba(255,235,59,0.5),
    0 0 25px rgba(255,235,59,0.3);
  transform: translateY(-2px);
}

#takeCancel {
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

#takeCancel:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-1px);
}

.empty-state {
  text-align: center;
  padding: 50px 25px;
  color: #ffd54f;
  grid-column: 1 / -1;
}

.empty-state i {
  font-size: 50px;
  margin-bottom: 25px;
  color: rgba(255,235,59,0.4);
  animation: float 4s ease-in-out infinite;
}

.empty-state p {
  font-size: 12px;
  line-height: 1.8;
  text-shadow: 0 0 10px rgba(255,235,59,0.3);
}

.completed-section {
  display: none;
}

.player-filter {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.player-filter select {
  background: rgba(30, 30, 30, 0.95);
  color: #ffd54f;
  border: 1px solid rgba(255,235,59,0.4);
  padding: 10px 18px;
  border-radius: 10px;
  font-family: 'Press Start 2P', cursive;
  font-size: 9px;
  transition: all 0.3s ease;
}

.player-filter select:focus {
  outline: none;
  border: 1px solid #ffeb3b;
  box-shadow: 0 0 15px rgba(255,235,59,0.3);
}

.edit-modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.95);
  display: none; 
  justify-content: center; 
  align-items: center;
  z-index: 200;
  backdrop-filter: blur(10px);
  animation: lightOn 0.3s ease-out;
}

.edit-modal-content {
  background: rgba(25, 25, 25, 0.95);
  padding: 35px;
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  display: flex; 
  flex-direction: column; 
  gap: 18px;
  box-shadow: 
    0 20px 50px rgba(255,235,59,0.25),
    0 0 60px rgba(255,152,0,0.2);
  border: 1px solid rgba(255,235,59,0.3);
  backdrop-filter: blur(20px);
  animation: glowPulse 3s ease-in-out infinite;
}

.edit-modal-content h3 {
  margin: 0 0 18px 0;
  color: #ffeb3b;
  font-size: 14px;
  text-align: center;
  text-shadow: 0 0 10px rgba(255,152,0,0.5);
}

.edit-modal-content input, 
.edit-modal-content select, 
.edit-modal-content textarea, 
.edit-modal-content button {
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}

.edit-modal-content input, 
.edit-modal-content select, 
.edit-modal-content textarea {
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,235,59,0.4);
  background: rgba(30, 30, 30, 0.9);
  color: #ffeb3b;
  transition: all 0.3s ease;
}

.edit-modal-content input:focus, 
.edit-modal-content select:focus, 
.edit-modal-content textarea:focus {
  outline: none;
  border: 1px solid #ffeb3b;
  box-shadow: 
    0 0 15px rgba(255,235,59,0.4),
    inset 0 0 10px rgba(255,235,59,0.1);
  transform: translateY(-1px);
}

.edit-modal-content button {
  padding: 12px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.edit-modal-save {
  background: linear-gradient(135deg, #ffeb3b, #ffd54f);
  color: #000;
}

.edit-modal-save:hover {
  background: linear-gradient(135deg, #ffd54f, #ffeb3b);
  box-shadow: 
    0 5px 20px rgba(255,235,59,0.5),
    0 0 25px rgba(255,235,59,0.3);
  transform: translateY(-2px);
}

.edit-modal-cancel {
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.edit-modal-cancel:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-1px);
}

.edit-modal-buttons {
  display: flex;
  gap: 12px;
  margin-top: 15px;
}

.edit-modal-buttons button {
  flex: 1;
}

@media (max-width: 768px) {
  .container {
    grid-template-columns: 1fr;
    padding: 15px;
  }
  
  h1 {
    font-size: 24px;
  }
  
  #addTaskPanel {
    width: 95%;
    max-width: none;
    margin: 0 auto;
  }
  
  .tabs {
    flex-direction: column;
    align-items: center;
  }
  
  .tab-btn {
    width: 85%;
  }
  
  .edit-modal-content {
    width: 95%;
    max-width: none;
  }
  
  .bulb {
    font-size: 36px;
  }
  
  #addTaskBtn {
    width: 60px;
    height: 60px;
    font-size: 24px;
    bottom: 30px;
    right: 30px;
  }
  
  .panel-tabs {
    flex-direction: column;
  }
  
  .panel-tab {
    min-width: auto;
  }
  
  .template-item, .pack-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .template-actions, .pack-actions {
    align-self: flex-end;
  }
}

@media (max-width: 480px) {
  #addTaskPanel {
    padding: 15px;
    gap: 12px;
  }
  
  .panel-tab {
    font-size: 7px;
    padding: 6px 8px;
  }
  
  .template-title, .pack-title {
    font-size: 9px;
  }
  
  .template-desc, .pack-desc {
    font-size: 7px;
  }
}

</style>
</head>
<body>
<div class="mc-background"></div>
<div class="light-overlay"></div>
<div class="sparkles"></div>
<div class="bulb-container">
  <div class="bulb">💡</div>
</div>

<header>
  <h1>Доска заданий</h1>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="active">Активные задания</button>
  <button class="tab-btn" data-tab="completed">Выполненные задания</button>
</div>

<div class="active-section">
  <div class="filter-bar">
    <button class="filter-btn active" data-filter="all">Все задания</button>
    <button class="filter-btn" data-filter="urgent">Срочные</button>
    <button class="filter-btn" data-filter="daily">Ежедневные</button>
    <button class="filter-btn" data-filter="normal">Обычные</button>
    <button class="filter-btn" data-filter="inprogress">В процессе</button>
  </div>

  <div class="container" id="tasksBoard">
  </div>
</div>

<div class="completed-section">
  <div class="player-filter">
    <select id="playerFilter">
      <option value="all">Все игроки</option>
    </select>
  </div>

  <div class="container" id="completedTasksBoard">
  </div>
</div>

<button id="addTaskBtn">
  <i class="fas fa-lightbulb"></i>
</button>

<div id="addTaskPanel">
  <div class="panel-tabs">
    <button class="panel-tab active" data-panel="newTask">Новое задание</button>
    <button class="panel-tab" data-panel="templates">Шаблоны</button>
    <button class="panel-tab" data-panel="packs">Пакеты заданий</button>
  </div>

  <div class="panel-content active" id="newTaskPanel">
    <h3>Добавить новое задание</h3>
    <input type="text" id="taskTitle" placeholder="Название задания">
    <textarea id="taskDesc" placeholder="Описание (необязательно)" rows="3"></textarea>
    
    <div class="datetime-inputs">
      <div class="datetime-row">
        <input type="date" id="taskDate">
        <span>в</span>
        <input type="time" id="taskTime">
      </div>
    </div>
    
    <select id="taskCategory">
      <option value="urgent">Срочные</option>
      <option value="daily">Ежедневные</option>
      <option value="normal">Не срочные</option>
    </select>
    
    <button id="submitTask">Добавить задание</button>
  </div>

  <div class="panel-content" id="templatesPanel">
    <h3>Управление шаблонами</h3>
    
    <div class="templates-list" id="templatesList">
    </div>
    
    <div style="margin-top: 15px;">
      <h4 style="color: #ffd54f; font-size: 10px; margin-bottom: 10px;">Создать новый шаблон</h4>
      <input type="text" id="templateTitle" placeholder="Название шаблона">
      <textarea id="templateDesc" placeholder="Описание шаблона" rows="2"></textarea>
      <select id="templateCategory">
        <option value="urgent">Срочные</option>
        <option value="daily">Ежедневные</option>
        <option value="normal">Не срочные</option>
      </select>
      
      <div class="template-deadline">
        <div style="font-size: 9px; color: #ffd54f; margin-bottom: 8px;">Срок выполнения (опционально):</div>
        <div class="datetime-row">
          <input type="date" id="templateDate">
          <span>в</span>
          <input type="time" id="templateTime">
        </div>
      </div>
      
      <button id="createTemplate">Создать шаблон</button>
    </div>
  </div>

  <div class="panel-content" id="packsPanel">
    <h3>Пакеты заданий</h3>
    
    <div class="packs-list" id="packsList">
    </div>
    
    <div style="margin-top: 15px;">
      <h4 style="color: #ffd54f; font-size: 10px; margin-bottom: 10px;">Создать новый пакет</h4>
      <input type="text" id="packTitle" placeholder="Название пакета">
      <textarea id="packDesc" placeholder="Описание пакета" rows="2"></textarea>
      
      <div class="pack-templates">
        <div style="font-size: 9px; color: #ffd54f; margin-bottom: 8px;">Выберите шаблоны для пакета:</div>
        <div id="availableTemplates" class="template-list">
        </div>
      </div>
      
      <button id="createPack">Создать пакет</button>
    </div>
  </div>
</div>

<div id="takeModal">
  <div id="modalContent">
    <div id="modalTitle"></div>
    <input type="text" id="playerName" placeholder="Введите ваш ник">
    <button id="takeConfirm">Взять задание</button>
    <button id="takeCancel">Отмена</button>
  </div>
</div>

<div class="edit-modal">
  <div class="edit-modal-content">
    <h3>Редактировать задание</h3>
    <input type="text" id="editTaskTitle" placeholder="Название задания">
    <textarea id="editTaskDesc" placeholder="Описание (необязательно)" rows="3"></textarea>
    
    <div class="datetime-inputs">
      <div class="datetime-row">
        <input type="date" id="editTaskDate">
        <span>в</span>
        <input type="time" id="editTaskTime">
      </div>
    </div>
    
    <select id="editTaskCategory">
      <option value="urgent">Срочные</option>
      <option value="daily">Ежедневные</option>
      <option value="normal">Не срочные</option>
    </select>
    
    <div class="edit-modal-buttons">
      <button class="edit-modal-save" id="saveEditTask">Сохранить</button>
      <button class="edit-modal-cancel" id="cancelEditTask">Отмена</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAb1xT6mIHlxcZNt1TBS7jrrDp5re3qMOU",
  authDomain: "klan-d9201.firebaseapp.com",
  databaseURL: "https://klan-d9201-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "klan-d9201",
  storageBucket: "klan-d9201.appspot.com",
  messagingSenderId: "252485302766",
  appId: "1:252485302766:web:7f60cca53e9c9b2d38f6ff"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const addBtn = document.getElementById('addTaskBtn');
const addPanel = document.getElementById('addTaskPanel');
const submitTask = document.getElementById('submitTask');
const taskTitle = document.getElementById('taskTitle');
const taskDesc = document.getElementById('taskDesc');
const taskCategory = document.getElementById('taskCategory');
const taskDate = document.getElementById('taskDate');
const taskTime = document.getElementById('taskTime');
const tasksBoard = document.getElementById('tasksBoard');
const completedTasksBoard = document.getElementById('completedTasksBoard');
const filterBtns = document.querySelectorAll('.filter-btn');
const tabBtns = document.querySelectorAll('.tab-btn');
const playerFilter = document.getElementById('playerFilter');
const activeSection = document.querySelector('.active-section');
const completedSection = document.querySelector('.completed-section');

const takeModal = document.getElementById('takeModal');
const modalTitle = document.getElementById('modalTitle');
const playerNameInput = document.getElementById('playerName');
const takeConfirm = document.getElementById('takeConfirm');
const takeCancel = document.getElementById('takeCancel');

const editModal = document.querySelector('.edit-modal');
const editTaskTitle = document.getElementById('editTaskTitle');
const editTaskDesc = document.getElementById('editTaskDesc');
const editTaskCategory = document.getElementById('editTaskCategory');
const editTaskDate = document.getElementById('editTaskDate');
const editTaskTime = document.getElementById('editTaskTime');
const saveEditTask = document.getElementById('saveEditTask');
const cancelEditTask = document.getElementById('cancelEditTask');

const panelTabs = document.querySelectorAll('.panel-tab');
const panelContents = document.querySelectorAll('.panel-content');
const templatesList = document.getElementById('templatesList');
const templateTitle = document.getElementById('templateTitle');
const templateDesc = document.getElementById('templateDesc');
const templateCategory = document.getElementById('templateCategory');
const templateDate = document.getElementById('templateDate');
const templateTime = document.getElementById('templateTime');
const createTemplateBtn = document.getElementById('createTemplate');

const packsList = document.getElementById('packsList');
const packTitle = document.getElementById('packTitle');
const packDesc = document.getElementById('packDesc');
const availableTemplates = document.getElementById('availableTemplates');
const createPackBtn = document.getElementById('createPack');

let currentTaskId = null;
let currentFilter = 'all';
let currentTab = 'active';
let editingTaskId = null;
let editingTemplateId = null;
let editingPackId = null;
let selectedTemplates = new Set();

const today = new Date().toISOString().split('T')[0];
taskDate.min = today;
editTaskDate.min = today;
templateDate.min = today;

panelTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const panel = tab.dataset.panel;
    
    panelTabs.forEach(t => t.classList.remove('active'));
    panelContents.forEach(c => c.classList.remove('active'));
    
    tab.classList.add('active');
    document.getElementById(panel + 'Panel').classList.add('active');
    
    if (panel === 'templates') {
      loadTemplates();
    } else if (panel === 'packs') {
      loadPacks();
      loadAvailableTemplates();
    }
  });
});

function createSparkles() {
  const sparklesContainer = document.querySelector('.sparkles');
  const sparkleCount = 25;
  
  for (let i = 0; i < sparkleCount; i++) {
    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle';
    sparkle.style.left = Math.random() * 100 + '%';
    sparkle.style.top = Math.random() * 100 + '%';
    sparkle.style.animationDelay = Math.random() * 3 + 's';
    sparkle.style.animationDuration = (2 + Math.random() * 2) + 's';
    sparkle.style.width = (2 + Math.random() * 3) + 'px';
    sparkle.style.height = sparkle.style.width;
    sparklesContainer.appendChild(sparkle);
  }
}

createSparkles();

tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    tabBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentTab = btn.dataset.tab;
    
    if (currentTab === 'active') {
      activeSection.style.display = 'block';
      completedSection.style.display = 'none';
    } else {
      activeSection.style.display = 'none';
      completedSection.style.display = 'block';
      renderCompletedTasksFromSnapshot(lastSnapshot);
    }
  });
});

addBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  addPanel.style.display = addPanel.style.display === 'flex' ? 'none' : 'flex';
});

filterBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    filterBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderTasksFromSnapshot(lastSnapshot);
  });
});

submitTask.onclick = () => {
  const title = taskTitle.value.trim();
  if (!title) return alert('Название задания обязательно!');
  const desc = taskDesc.value.trim();
  const category = taskCategory.value;
  
  let deadline = null;
  if (taskDate.value && taskTime.value) {
    const dateTimeString = `${taskDate.value}T${taskTime.value}`;
    deadline = new Date(dateTimeString).getTime();
  }
  
  push(ref(db, 'tasks'), { 
    title, 
    desc, 
    category, 
    deadline, 
    status: 'new'
  });
  
  taskTitle.value = ''; 
  taskDesc.value = ''; 
  taskDate.value = '';
  taskTime.value = '';
  addPanel.style.display = 'none';
};

function loadTemplates() {
  onValue(ref(db, 'templates'), (snapshot) => {
    templatesList.innerHTML = '';
    
    if (!snapshot.exists()) {
      templatesList.innerHTML = '<div class="empty-state" style="padding: 20px; color: #ffd54f; text-align: center;">Нет созданных шаблонов</div>';
      return;
    }
    
    snapshot.forEach(templateSnap => {
      const template = templateSnap.val();
      const templateItem = createTemplateElement(templateSnap.key, template);
      templatesList.appendChild(templateItem);
    });
  });
}

function createTemplateElement(id, template) {
  const item = document.createElement('div');
  item.className = 'template-item';
  
  let deadlineInfo = '';
  if (template.deadline) {
    const deadlineDate = new Date(template.deadline);
    deadlineInfo = `<div class="template-desc">Срок: ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString().slice(0,5)}</div>`;
  }
  
  item.innerHTML = `
    <div class="template-info">
      <div class="template-title">${template.title}</div>
      <div class="template-desc">${template.desc || 'Без описания'}</div>
      <div class="template-desc">Категория: ${getCategoryName(template.category)}</div>
      ${deadlineInfo}
    </div>
    <div class="template-actions">
      <button class="template-action-btn use-template" title="Использовать шаблон">
        <i class="fas fa-plus"></i>
      </button>
      <button class="template-action-btn edit-template" title="Редактировать">
        <i class="fas fa-edit"></i>
      </button>
      <button class="template-action-btn delete-template" title="Удалить">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  
  item.querySelector('.use-template').addEventListener('click', (e) => {
    e.stopPropagation();
    useTemplate(template);
  });
  
  item.querySelector('.edit-template').addEventListener('click', (e) => {
    e.stopPropagation();
    editTemplate(id, template);
  });
  
  item.querySelector('.delete-template').addEventListener('click', (e) => {
    e.stopPropagation();
    if (confirm('Удалить этот шаблон?')) {
      remove(ref(db, 'templates/' + id));
    }
  });
  
  return item;
}

function getCategoryName(category) {
  const names = {
    'urgent': 'Срочные',
    'daily': 'Ежедневные',
    'normal': 'Не срочные'
  };
  return names[category] || category;
}

function useTemplate(template) {
  let deadline = template.deadline || null;
  
  push(ref(db, 'tasks'), {
    title: template.title,
    desc: template.desc || '',
    category: template.category,
    deadline: deadline,
    status: 'new'
  });
  
  addPanel.style.display = 'none';
}

function editTemplate(id, template) {
  editingTemplateId = id;
  templateTitle.value = template.title;
  templateDesc.value = template.desc || '';
  templateCategory.value = template.category;
  
  if (template.deadline) {
    const deadlineDate = new Date(template.deadline);
    templateDate.value = deadlineDate.toISOString().split('T')[0];
    templateTime.value = deadlineDate.toTimeString().slice(0, 5);
  } else {
    templateDate.value = '';
    templateTime.value = '';
  }
  
  createTemplateBtn.textContent = 'Сохранить шаблон';
}

createTemplateBtn.addEventListener('click', () => {
  const title = templateTitle.value.trim();
  if (!title) return alert('Название шаблона обязательно!');
  
  let deadline = null;
  if (templateDate.value && templateTime.value) {
    const dateTimeString = `${templateDate.value}T${templateTime.value}`;
    deadline = new Date(dateTimeString).getTime();
  }
  
  const templateData = {
    title: title,
    desc: templateDesc.value.trim(),
    category: templateCategory.value,
    deadline: deadline
  };
  
  if (editingTemplateId) {
    update(ref(db, 'templates/' + editingTemplateId), templateData);
    editingTemplateId = null;
    createTemplateBtn.textContent = 'Создать шаблон';
  } else {
    push(ref(db, 'templates'), templateData);
  }
  
  templateTitle.value = '';
  templateDesc.value = '';
  templateCategory.value = 'normal';
  templateDate.value = '';
  templateTime.value = '';
});

function loadPacks() {
  onValue(ref(db, 'packs'), (snapshot) => {
    packsList.innerHTML = '';
    
    if (!snapshot.exists()) {
      packsList.innerHTML = '<div class="empty-state" style="padding: 20px; color: #ffd54f; text-align: center;">Нет созданных пакетов</div>';
      return;
    }
    
    snapshot.forEach(packSnap => {
      const pack = packSnap.val();
      const packItem = createPackElement(packSnap.key, pack);
      packsList.appendChild(packItem);
    });
  });
}

function loadAvailableTemplates() {
  onValue(ref(db, 'templates'), (snapshot) => {
    availableTemplates.innerHTML = '';
    selectedTemplates.clear();
    
    if (!snapshot.exists()) {
      availableTemplates.innerHTML = '<div style="color: #ffd54f; text-align: center; padding: 10px;">Нет доступных шаблонов</div>';
      return;
    }
    
    snapshot.forEach(templateSnap => {
      const template = templateSnap.val();
      const templateItem = document.createElement('div');
      templateItem.className = 'template-list-item';
      templateItem.innerHTML = `
        <input type="checkbox" id="template_${templateSnap.key}" value="${templateSnap.key}">
        <label for="template_${templateSnap.key}" style="margin-left: 5px;">${template.title}</label>
      `;
      
      templateItem.querySelector('input').addEventListener('change', (e) => {
        if (e.target.checked) {
          selectedTemplates.add(templateSnap.key);
        } else {
          selectedTemplates.delete(templateSnap.key);
        }
      });
      
      availableTemplates.appendChild(templateItem);
    });
  });
}

function createPackElement(id, pack) {
  const item = document.createElement('div');
  item.className = 'pack-item';
  
  let templatesInfo = '';
  if (pack.templates && Object.keys(pack.templates).length > 0) {
    templatesInfo = `<div class="pack-desc">Заданий: ${Object.keys(pack.templates).length}</div>`;
  }
  
  item.innerHTML = `
    <div class="pack-info">
      <div class="pack-title">${pack.title}</div>
      <div class="pack-desc">${pack.desc || 'Без описания'}</div>
      ${templatesInfo}
    </div>
    <div class="pack-actions">
      <button class="pack-action-btn use-pack" title="Использовать пакет">
        <i class="fas fa-layer-group"></i>
      </button>
      <button class="pack-action-btn edit-pack" title="Редактировать">
        <i class="fas fa-edit"></i>
      </button>
      <button class="pack-action-btn delete-pack" title="Удалить">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  
  item.querySelector('.use-pack').addEventListener('click', (e) => {
    e.stopPropagation();
    usePack(pack);
  });
  
  item.querySelector('.edit-pack').addEventListener('click', (e) => {
    e.stopPropagation();
    editPack(id, pack);
  });
  
  item.querySelector('.delete-pack').addEventListener('click', (e) => {
    e.stopPropagation();
    if (confirm('Удалить этот пакет?')) {
      remove(ref(db, 'packs/' + id));
    }
  });
  
  return item;
}

function usePack(pack) {
  if (!pack.templates) return;
  
  Object.values(pack.templates).forEach(templateId => {
    getTemplateById(templateId).then(template => {
      if (template) {
        let deadline = template.deadline || null;
        
        push(ref(db, 'tasks'), {
          title: template.title,
          desc: template.desc || '',
          category: template.category,
          deadline: deadline,
          status: 'new'
        });
      }
    });
  });
  
  addPanel.style.display = 'none';
}

function getTemplateById(templateId) {
  return new Promise((resolve) => {
    onValue(ref(db, 'templates/' + templateId), (snapshot) => {
      resolve(snapshot.val());
    }, { onlyOnce: true });
  });
}

function editPack(id, pack) {
  editingPackId = id;
  packTitle.value = pack.title;
  packDesc.value = pack.desc || '';
  
  selectedTemplates.clear();
  if (pack.templates) {
    Object.values(pack.templates).forEach(templateId => {
      selectedTemplates.add(templateId);
    });
  }
  
  createPackBtn.textContent = 'Сохранить пакет';
}

createPackBtn.addEventListener('click', () => {
  const title = packTitle.value.trim();
  if (!title) return alert('Название пакета обязательно!');
  if (selectedTemplates.size === 0) return alert('Выберите хотя бы один шаблон для пакета!');
  
  const packData = {
    title: title,
    desc: packDesc.value.trim(),
    templates: Object.fromEntries(Array.from(selectedTemplates).map((id, index) => [index, id]))
  };
  
  if (editingPackId) {
    update(ref(db, 'packs/' + editingPackId), packData);
    editingPackId = null;
    createPackBtn.textContent = 'Создать пакет';
  } else {
    push(ref(db, 'packs'), packData);
  }
  
  packTitle.value = '';
  packDesc.value = '';
  selectedTemplates.clear();
  
  const checkboxes = availableTemplates.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
});

function checkMidnightReset(tasks) {
  const now = Date.now();
  
  tasks.forEach(task => {
    const taskData = task.data;
    if (taskData.resetAtMidnight && taskData.nextResetTime && now >= taskData.nextResetTime) {
      if (taskData.status === 'completed') {
        update(ref(db, 'tasks/' + task.id), {
          status: 'new',
          player: null,
          completedAt: null,
          nextResetTime: getNextMidnight()
        });
      } else {
        update(ref(db, 'tasks/' + task.id), {
          nextResetTime: getNextMidnight()
        });
      }
    }
  });
}

function createTaskCard(id, data) {
  const card = document.createElement('div');
  card.className = `taskCard ${data.status === 'inprogress' ? 'inprogress' : data.status === 'completed' ? 'completed' : data.category}`;
  card.dataset.category = data.status === 'inprogress' ? 'inprogress' : data.status === 'completed' ? 'completed' : data.category;

  const header = document.createElement('div');
  header.className='taskHeader';
  const titleEl = document.createElement('div');
  titleEl.className='taskTitle';
  titleEl.textContent = data.title;

  const moreBtn = document.createElement('div');
  moreBtn.className='moreBtn';
  moreBtn.innerHTML='<i class="fas fa-ellipsis-v"></i>';

  const moreMenu = document.createElement('div');
  moreMenu.className='moreMenu';

  const editBtn = document.createElement('button');
  editBtn.innerHTML='<i class="fas fa-edit"></i> Редактировать';
  const delBtn = document.createElement('button');
  delBtn.innerHTML='<i class="fas fa-trash"></i> Удалить';
  moreMenu.append(editBtn, delBtn);
  
  moreBtn.onclick = (e) => {
    e.stopPropagation();
    moreMenu.style.display = moreMenu.style.display==='flex'?'none':'flex';
  };
  
  editBtn.onclick = ()=> {
    editingTaskId = id;
    editTaskTitle.value = data.title;
    editTaskDesc.value = data.desc || '';
    editTaskCategory.value = data.category;
    
    if (data.deadline) {
      const deadlineDate = new Date(data.deadline);
      editTaskDate.value = deadlineDate.toISOString().split('T')[0];
      editTaskTime.value = deadlineDate.toTimeString().slice(0, 5);
    } else {
      editTaskDate.value = '';
      editTaskTime.value = '';
    }
    
    editModal.style.display = 'flex';
    moreMenu.style.display = 'none';
  };
  
  delBtn.onclick = ()=> {
    if(confirm('Вы уверены, что хотите удалить это задание?')) {
      remove(ref(db,'tasks/'+id));
    }
    moreMenu.style.display = 'none';
  };
  
  document.addEventListener('click', (e) => {
    if (!moreMenu.contains(e.target) && !moreBtn.contains(e.target)) {
      moreMenu.style.display = 'none';
    }
  });
  
  header.append(titleEl, moreBtn, moreMenu);

  const descEl = document.createElement('div');
  descEl.className='taskDesc';
  descEl.textContent=data.desc || '';

  const footer = document.createElement('div');
  footer.className='taskFooter';
  const priorityLabel = document.createElement('div');
  priorityLabel.className='priorityLabel';
  
  if (data.status === 'inprogress') {
    priorityLabel.textContent = 'В процессе';
    const playerTag = document.createElement('div');
    playerTag.className='playerNameTag';
    playerTag.textContent = data.player || '???';
    footer.append(priorityLabel, playerTag);
  } else if (data.status === 'completed') {
    priorityLabel.textContent = 'Выполнено';
    const playerTag = document.createElement('div');
    playerTag.className='playerNameTag';
    playerTag.textContent = data.player || '???';
    const completedDate = document.createElement('div');
    completedDate.className='countdown';
    completedDate.textContent = `Выполнено: ${new Date(data.completedAt).toLocaleDateString()}`;
    footer.append(priorityLabel, playerTag);
    card.append(completedDate);
  } else {
    priorityLabel.textContent = data.category==='urgent'?'Срочное':data.category==='daily'?'Ежедневное':'Обычное';
    footer.append(priorityLabel);
  }

  card.append(header, descEl);

  if(data.deadline && data.status !== 'completed'){
    const countdown = document.createElement('div');
    countdown.className='countdown';
    card.append(countdown);
    
    const updateCountdown = () => {
      const now=Date.now();
      const diff=Math.max(0, data.deadline-now);
      const d=Math.floor(diff/86400000);
      const h=Math.floor((diff%86400000)/3600000);
      const m=Math.floor((diff%3600000)/60000);
      const s=Math.floor((diff%60000)/1000);
      countdown.textContent=`⏱️ ${d}д ${h}ч ${m}м ${s}с`;
    };
    
    updateCountdown();
    const countdownInterval = setInterval(updateCountdown, 1000);
    
    card.dataset.countdownInterval = countdownInterval;
  }

  if (data.status === 'new') {
    const takeBtn = document.createElement('button');
    takeBtn.className='takeBtn';
    takeBtn.innerHTML='<i class="fas fa-hand-paper"></i> Взять задание';
    takeBtn.onclick = ()=> {
      currentTaskId = id;
      modalTitle.textContent = data.title;
      playerNameInput.value='';
      takeModal.style.display='flex';
    };
    card.append(takeBtn);
  } else if (data.status === 'inprogress') {
    const completeBtn = document.createElement('button');
    completeBtn.className='completeBtn';
    completeBtn.innerHTML='<i class="fas fa-check"></i> Задание выполнено';
    completeBtn.onclick = () => {
      card.style.animation = 'flyAway 1s forwards';
      
      setTimeout(() => {
        update(ref(db, 'tasks/' + id), {
          status: 'completed',
          completedAt: Date.now()
        });
      }, 1000);
    };
    card.append(completeBtn);
  }

  card.append(footer);
  return card;
}

let lastSnapshot = null;

function renderTasksFromSnapshot(snapshot){
  if (!snapshot) return;
  
  tasksBoard.innerHTML='';
  const tasks = [];
  snapshot.forEach(s=>{
    const taskData = s.val();
    if (taskData.status !== 'completed') {
      tasks.push({id:s.key, data:taskData});
    }
  });
  
  checkMidnightReset(tasks);
  
  const filteredTasks = tasks.filter(task => {
    if (currentFilter === 'all') return true;
    if (currentFilter === 'inprogress') return task.data.status === 'inprogress';
    return task.data.category === currentFilter && task.data.status !== 'inprogress';
  });
  
  if (filteredTasks.length === 0) {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    emptyState.innerHTML = `
      <i class="fas fa-tasks"></i>
      <p>Нет заданий для отображения</p>
      <p>Создайте новое задание, нажав на кнопку лампочки</p>
    `;
    tasksBoard.append(emptyState);
    return;
  }
  
  const prio={'urgent':4,'daily':3,'normal':2,'inprogress':1};
  filteredTasks.sort((a,b)=> (prio[b.data.category]||0)-(prio[a.data.category]||0));
  filteredTasks.forEach(t=>tasksBoard.append(createTaskCard(t.id,t.data)));
}

function renderCompletedTasksFromSnapshot(snapshot) {
  if (!snapshot) return;
  
  completedTasksBoard.innerHTML='';
  const tasks = [];
  const players = new Set();
  
  snapshot.forEach(s=>{
    const taskData = s.val();
    if (taskData.status === 'completed') {
      tasks.push({id:s.key, data:taskData});
      if (taskData.player) {
        players.add(taskData.player);
      }
    }
  });
  
  updatePlayerFilter(players);
  
  const selectedPlayer = playerFilter.value;
  const filteredTasks = selectedPlayer === 'all' 
    ? tasks 
    : tasks.filter(task => task.data.player === selectedPlayer);
  
  if (filteredTasks.length === 0) {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    emptyState.innerHTML = `
      <i class="fas fa-check-circle"></i>
      <p>Нет выполненных заданий</p>
      <p>Выполненные задания появятся здесь</p>
    `;
    completedTasksBoard.append(emptyState);
    return;
  }
  
  filteredTasks.sort((a, b) => (b.data.completedAt || 0) - (a.data.completedAt || 0));
  filteredTasks.forEach(t => completedTasksBoard.append(createTaskCard(t.id, t.data)));
}

function updatePlayerFilter(players) {
  const currentValue = playerFilter.value;
  
  playerFilter.innerHTML = '<option value="all">Все игроки</option>';
  
  const sortedPlayers = Array.from(players).sort();
  sortedPlayers.forEach(player => {
    const option = document.createElement('option');
    option.value = player;
    option.textContent = player;
    playerFilter.appendChild(option);
  });
  
  if (sortedPlayers.includes(currentValue)) {
    playerFilter.value = currentValue;
  }
}

function renderTasks(snapshot){
  lastSnapshot = snapshot;
  
  if (currentTab === 'active') {
    renderTasksFromSnapshot(snapshot);
  } else {
    renderCompletedTasksFromSnapshot(snapshot);
  }
}

onValue(ref(db,'tasks'), renderTasks);

playerFilter.addEventListener('change', () => {
  renderCompletedTasksFromSnapshot(lastSnapshot);
});

saveEditTask.onclick = () => {
  const title = editTaskTitle.value.trim();
  if (!title) return alert('Название задания обязательно!');
  const desc = editTaskDesc.value.trim();
  const category = editTaskCategory.value;
  
  let deadline = null;
  if (editTaskDate.value && editTaskTime.value) {
    const dateTimeString = `${editTaskDate.value}T${editTaskTime.value}`;
    deadline = new Date(dateTimeString).getTime();
  }
  
  update(ref(db, 'tasks/' + editingTaskId), { 
    title, 
    desc, 
    category, 
    deadline
  });
  
  editModal.style.display = 'none';
  editingTaskId = null;
};

cancelEditTask.onclick = () => {
  editModal.style.display = 'none';
  editingTaskId = null;
};

takeConfirm.onclick = ()=>{
  const name = playerNameInput.value.trim();
  if(!name) return alert('Введите ник!');
  update(ref(db,'tasks/'+currentTaskId),{status:'inprogress',player:name});
  takeModal.style.display='none';
};

takeCancel.onclick = ()=>takeModal.style.display='none';

takeModal.addEventListener('click', (e) => {
  if (e.target === takeModal) {
    takeModal.style.display = 'none';
  }
});

editModal.addEventListener('click', (e) => {
  if (e.target === editModal) {
    editModal.style.display = 'none';
    editingTaskId = null;
  }
});

document.addEventListener('click', (e) => {
  if (!addPanel.contains(e.target) && e.target !== addBtn) {
    addPanel.style.display = 'none';
  }
});

loadTemplates();
loadPacks();
</script>
</body>
</html>