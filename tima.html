<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Доска заданий Клана Minecraft</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Press Start 2P', cursive;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: #fff;
  }
  h1 {
    text-align: center;
    padding: 20px 0;
    font-size: 20px;
    color: #00fff7;
    text-shadow: 0 0 8px #00fff7, 0 0 16px #00fff7;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }

  .taskCard {
    background: #1b1b1b;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,255,255,0.4);
    padding: 15px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 150px;
    height: 180px;
    width: 250px;
    position: relative;
    transition: transform 0.2s, box-shadow 0.2s;
    overflow: hidden;
  }
  .taskCard:hover { transform: translateY(-5px); box-shadow: 0 0 25px rgba(0,255,255,0.6); }

  .taskHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .taskTitle { font-size: 12px; word-break: break-word; color: #00fff7; }
  .taskDesc { font-size: 10px; margin-top: 5px; color: #a0fff0; }
  .taskFooter { display: flex; justify-content: space-between; margin-top: 10px; font-size: 10px; }

  .taskBtn, .takeBtn, .editBtn {
    cursor: pointer;
    border: none;
    border-radius: 4px;
    font-size: 10px;
    padding: 4px 8px;
    transition: 0.2s;
  }
  .taskBtn { background: #ff1744; color: white; }
  .taskBtn:hover { background: #d5002c; }
  .takeBtn { background: #2979ff; color: white; }
  .takeBtn:hover { background: #1565c0; }
  .editBtn { background: #00ffea; color: #000; }
  .editBtn:hover { background: #00bcd4; }

  .urgent { border-left: 5px solid #ff1744; }
  .daily { border-left: 5px solid #ff9100; }
  .normal { border-left: 5px solid #00e676; }
  .inprogress { border-left: 5px solid #2979ff; background: #0d47a1; }

  #addTaskBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #00fff7;
    color: #000;
    border: 3px solid #00fff7;
    width: 40px;
    height: 40px;
    font-size: 20px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 100;
  }

  #addTaskPanel {
    position: fixed;
    top: 20px;
    right: 70px;
    background: rgba(0,0,0,0.85);
    padding: 15px;
    border-radius: 6px;
    display: none;
    flex-direction: column;
    gap: 10px;
    z-index: 99;
  }
  #addTaskPanel input, #addTaskPanel select, #addTaskPanel textarea, #addTaskPanel button {
    font-family: 'Press Start 2P', cursive;
    font-size: 10px;
  }
  #addTaskPanel input, #addTaskPanel select, #addTaskPanel textarea {
    padding: 5px;
    border-radius: 4px;
    border: none;
    background: #121212;
    color: #00fff7;
  }
  #addTaskPanel button {
    background: #00fff7;
    color: #000;
    border: 2px solid #00fff7;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
  }

  #takeModal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: none; justify-content: center; align-items: center;
    z-index: 200;
  }
  #modalContent {
    background: #212121;
    padding: 20px;
    border-radius: 8px;
    min-width: 250px;
    display: flex; flex-direction: column; gap: 10px;
  }

  .countdown { font-size: 10px; margin-top: 5px; color: #00fff7; }

  .moreBtn { position: absolute; top: 5px; right: 5px; cursor: pointer; font-size: 16px; }
  .moreMenu {
    position: absolute;
    top: 20px; right: 5px;
    background: #424242;
    display: none; flex-direction: column;
    border-radius: 4px; overflow: hidden;
    z-index: 10;
  }
  .moreMenu button { font-size: 10px; padding: 5px; background: #616161; color: #fff; border: none; cursor: pointer; }
  .moreMenu button:hover { background: #757575; }
</style>
</head>
<body>
<h1>Доска заданий Клана Minecraft</h1>

<button id="addTaskBtn">+</button>

<div id="addTaskPanel">
  <input type="text" id="taskTitle" placeholder="Название задания">
  <textarea id="taskDesc" placeholder="Описание (необязательно)" rows="3"></textarea>
  <input type="datetime-local" id="taskDeadline">
  <select id="taskCategory">
    <option value="urgent">Срочные</option>
    <option value="daily">Ежедневные</option>
    <option value="normal">Не срочные</option>
  </select>
  <button id="submitTask">Добавить</button>
</div>

<div class="container" id="tasksBoard"></div>

<div id="takeModal">
  <div id="modalContent">
    <div id="modalTitle"></div>
    <input type="text" id="playerName" placeholder="Введите ваш ник">
    <button id="takeConfirm">Взять задание</button>
    <button id="takeCancel">Отмена</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAb1xT6mIHlxcZNt1TBS7jrrDp5re3qMOU",
  authDomain: "klan-d9201.firebaseapp.com",
  databaseURL: "https://klan-d9201-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "klan-d9201",
  storageBucket: "klan-d9201.appspot.com",
  messagingSenderId: "252485302766",
  appId: "1:252485302766:web:7f60cca53e9c9b2d38f6ff"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const addBtn = document.getElementById('addTaskBtn');
const addPanel = document.getElementById('addTaskPanel');
const submitTask = document.getElementById('submitTask');
const taskTitle = document.getElementById('taskTitle');
const taskDesc = document.getElementById('taskDesc');
const taskCategory = document.getElementById('taskCategory');
const taskDeadline = document.getElementById('taskDeadline');
const tasksBoard = document.getElementById('tasksBoard');

const takeModal = document.getElementById('takeModal');
const modalTitle = document.getElementById('modalTitle');
const playerName = document.getElementById('playerName');
const takeConfirm = document.getElementById('takeConfirm');
const takeCancel = document.getElementById('takeCancel');
let currentTaskId = null;

addBtn.onclick = () => addPanel.style.display = addPanel.style.display === 'flex' ? 'none' : 'flex';

submitTask.onclick = () => {
  const title = taskTitle.value.trim();
  if(!title) return;
  push(ref(db,'tasks'),{
    title,
    desc: taskDesc.value.trim(),
    category: taskCategory.value,
    deadline: taskDeadline.value || null,
    status: "new",
    player: null
  });
  taskTitle.value = taskDesc.value = taskDeadline.value = '';
  addPanel.style.display = 'none';
};

function getTimeRemaining(deadline){
  const end = new Date(deadline).getTime();
  const now = Date.now();
  const diff = end - now;
  if(diff<=0) return "Время вышло!";
  const d = Math.floor(diff/(1000*60*60*24));
  const h = Math.floor((diff/(1000*60*60))%24);
  const m = Math.floor((diff/(1000*60))%60);
  const s = Math.floor((diff/1000)%60);
  return `${d}д ${h}ч ${m}м ${s}с`;
}

const tasksRef = ref(db, 'tasks');
onValue(tasksRef, snapshot => {
  const data = snapshot.val() || {};
  tasksBoard.innerHTML = '';

  const sorted = Object.entries(data).sort(([id1,t1],[id2,t2])=>{
    const order = {"urgent":0,"daily":1,"normal":2};
    return (order[t1.category]||3) - (order[t2.category]||3);
  });

  sorted.forEach(([id, task]) => {
    const card = document.createElement('div');
    let className = task.status==="inprogress"?"inprogress":task.category;
    card.className = `taskCard ${className}`;

    const header = document.createElement('div'); header.className="taskHeader";
    const titleDiv = document.createElement('div'); titleDiv.className="taskTitle"; titleDiv.textContent = task.title;
    const moreBtn = document.createElement('div'); moreBtn.textContent="⋮"; moreBtn.className="moreBtn";
    const moreMenu = document.createElement('div'); moreMenu.className="moreMenu";
    const editBtn = document.createElement('button'); editBtn.textContent="Редактировать";
    const delBtn = document.createElement('button'); delBtn.textContent="Удалить";
    moreMenu.appendChild(editBtn); moreMenu.appendChild(delBtn);
    moreBtn.onclick=()=>{ moreMenu.style.display=moreMenu.style.display==='flex'?'none':'flex'; }

    header.appendChild(titleDiv); header.appendChild(moreBtn); header.appendChild(moreMenu);
    card.appendChild(header);

    if(task.desc) {
      const descDiv = document.createElement('div'); descDiv.className="taskDesc"; descDiv.textContent=task.desc;
      card.appendChild(descDiv);
    }

    if(task.deadline){
      const timerDiv = document.createElement('div'); timerDiv.className="countdown";
      card.appendChild(timerDiv);
      setInterval(()=>{ timerDiv.textContent=getTimeRemaining(task.deadline); },1000);
    }

    const footer = document.createElement('div'); footer.className="taskFooter";

    if(task.status==="new"){
      const takeBtn = document.createElement('button'); takeBtn.className="takeBtn"; takeBtn.textContent="Взять задание";
      takeBtn.onclick = ()=>{
        takeModal.style.display="flex";
        modalTitle.textContent = task.title;
        currentTaskId = id;
      };
      footer.appendChild(takeBtn);
    } else {
      footer.textContent = `В процессе: ${task.player}`;
    }

    card.appendChild(footer);

    delBtn.onclick = ()=>remove(ref(db,'tasks/'+id));
    editBtn.onclick = ()=>{
      const newTitle = prompt("Новое название",task.title);
      if(newTitle) update(ref(db,'tasks/'+id),{title:newTitle});
      const newDesc = prompt("Новое описание",task.desc||"");
      update(ref(db,'tasks/'+id),{desc:newDesc});
    }

    tasksBoard.appendChild(card);
  });
});

takeConfirm.onclick = ()=>{
  const name = playerName.value.trim();
  if(!name) return;
  update(ref(db,'tasks/'+currentTaskId),{status:"inprogress",player:name});
  takeModal.style.display="none";
  playerName.value="";
};
takeCancel.onclick = ()=>{ takeModal.style.display="none"; playerName.value=""; };
</script>
</body>
</html>
