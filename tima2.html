<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–æ—Å–∫–∞ –∑–∞–¥–∞–Ω–∏–π</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin: 0;
  font-family: 'Press Start 2P', cursive;
  background: #000;
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}
.mc-background,
.light-overlay,
.sparkles {
  display: none !important;
}
.bulb-container {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1;
}
.bulb {
  font-size: 32px;
  color: #ffeb3b;
}
header {
  text-align: center;
  padding: 60px 0 20px;
  position: relative;
  z-index: 1;
}
h1 {
  font-size: 24px;
  color: #ffeb3b;
  margin-bottom: 15px;
}
.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
  gap: 10px;
  flex-wrap: wrap;
  position: relative;
  z-index: 1;
}
.tab-btn {
  background: #141414;
  color: #ffd54f;
  border: 1px solid #555;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}
.tab-btn.active {
  background: #222;
  color: #ffeb3b;
  border-color: #ffeb3b;
}
.filter-bar {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  position: relative;
  z-index: 1;
}
.filter-btn {
  background: #1e1e1e;
  color: #ffd54f;
  border: 1px solid #444;
  padding: 6px 12px;
  border-radius: 20px;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 9px;
}
.filter-btn.active {
  background: #2a2a2a;
  color: #ffeb3b;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 15px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  position: relative;
  z-index: 1;
}
.taskCard {
  background: #191919;
  border-radius: 12px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: 180px;
  border: 1px solid #444;
  position: relative;
}
.taskCard::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: #ffeb3b;
}
.urgent::before { background: #ff5252; }
.daily::before { background: #ffb74d; }
.inprogress::before { background: #ff9800; }
.completed::before { background: #ffd54f; }
.taskHeader {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}
.taskTitle {
  font-size: 14px;
  color: #ffeb3b;
  flex: 1;
  margin-right: 10px;
  word-break: break-word;
}
.taskDesc {
  font-size: 10px;
  color: #ffd54f;
  margin-top: 8px;
  opacity: 0.9;
}
.taskFooter {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  font-size: 10px;
}
.priorityLabel {
  font-size: 9px;
  padding: 4px 10px;
  border-radius: 12px;
  background: #333;
  color: #ffd54f;
}
.urgent .priorityLabel { color: #ff5252; }
.daily .priorityLabel { color: #ffb74d; }
.inprogress .priorityLabel { color: #ff9800; }
.playerNameTag {
  font-size: 9px;
  color: #fff;
  background: #333;
  padding: 4px 8px;
  border-radius: 12px;
}
.countdown {
  font-size: 10px;
  color: #ffeb3b;
  background: #333;
  padding: 4px 10px;
  border-radius: 12px;
  display: inline-block;
  margin-top: 8px;
}
.takeBtn, .completeBtn, .useTemplateBtn, .usePackBtn {
  background: #ffeb3b;
  color: #000;
  font-size: 10px;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-weight: bold;
  margin-top: 10px;
  align-self: flex-start;
}
.moreBtn {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ffd54f;
  cursor: pointer;
}
.moreMenu {
  position: absolute;
  top: 35px;
  right: 0;
  background: #282828;
  display: none;
  flex-direction: column;
  border-radius: 8px;
  min-width: 160px;
  border: 1px solid #555;
  z-index: 10;
}
.moreMenu button {
  font-size: 10px;
  padding: 8px 12px;
  background: transparent;
  color: #fff;
  border: none;
  cursor: pointer;
  text-align: left;
  border-bottom: 1px solid #444;
}
.moreMenu button:last-child {
  border-bottom: none;
}
#addTaskBtn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #ffeb3b;
  color: #000;
  border: none;
  width: 56px;
  height: 56px;
  font-size: 22px;
  border-radius: 50%;
  cursor: pointer;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
}
#addTaskPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #000;
  padding: 20px;
  border-radius: 16px;
  display: none;
  flex-direction: column;
  gap: 15px;
  z-index: 99;
  width: 90%;
  max-width: 450px;
  max-height: 85vh;
  overflow-y: auto;
  border: 1px solid #555;
}
.panel-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.panel-tab {
  flex: 1;
  padding: 6px 10px;
  background: #1e1e1e;
  border: 1px solid #555;
  border-radius: 6px;
  color: #ffd54f;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 8px;
  text-align: center;
  min-width: 120px;
}
.panel-tab.active {
  background: #2a2a2a;
  color: #ffeb3b;
  border-color: #ffeb3b;
}
.panel-content {
  display: none;
}
.panel-content.active {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
#addTaskPanel h3 {
  margin: 0 0 15px 0;
  color: #ffeb3b;
  font-size: 14px;
  text-align: center;
}
#addTaskPanel input,
#addTaskPanel select,
#addTaskPanel textarea {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #555;
  background: #1e1e1e;
  color: #ffeb3b;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}
#addTaskPanel button {
  background: #ffeb3b;
  color: #000;
  border: none;
  padding: 10px;
  border-radius: 8px;
  font-weight: bold;
  margin-top: 8px;
}
.templates-list,
.packs-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #555;
  border-radius: 10px;
  padding: 10px;
  background: #1e1e1e;
}
.template-item,
.pack-item {
  padding: 10px;
  border-bottom: 1px solid #555;
  cursor: pointer;
}
.template-item:last-child,
.pack-item:last-child {
  border-bottom: none;
}
.template-title,
.pack-title {
  font-size: 10px;
  color: #ffeb3b;
  margin-bottom: 5px;
}
.template-desc,
.pack-desc {
  font-size: 8px;
  color: #ffd54f;
}
#takeModal,
.edit-modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: #000;
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 200;
}
#modalContent,
.edit-modal-content {
  background: #191919;
  padding: 25px;
  border-radius: 16px;
  min-width: 300px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  border: 1px solid #555;
}
#modalTitle,
.edit-modal-content h3 {
  font-size: 16px;
  color: #ffeb3b;
  text-align: center;
  margin-bottom: 10px;
}
#takeConfirm,
#takeCancel,
.edit-modal-save,
.edit-modal-cancel {
  padding: 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}
#takeConfirm,
.edit-modal-save {
  background: #ffeb3b;
  color: #000;
  font-weight: bold;
}
#takeCancel,
.edit-modal-cancel {
  background: #333;
  color: #fff;
  border: 1px solid #555;
}
#registrationScreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #000;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.registration-modal {
  background: #191919;
  padding: 30px;
  border-radius: 16px;
  width: 90%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  border: 1px solid #555;
}
.registration-modal h2 {
  color: #ffeb3b;
  text-align: center;
}
.registration-modal input {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #555;
  background: #1e1e1e;
  color: #ffeb3b;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}
.registration-modal button {
  background: #ffeb3b;
  color: #000;
  border: none;
  padding: 10px;
  border-radius: 8px;
  font-weight: bold;
}
.registration-status {
  font-size: 9px;
  padding: 8px;
  border-radius: 5px;
  text-align: center;
  margin-top: 10px;
}
.registration-success {
  background: rgba(76, 175, 80, 0.2);
  color: #4caf50;
  border: 1px solid rgba(76, 175, 80, 0.5);
}
.registration-error {
  background: rgba(244, 67, 54, 0.2);
  color: #f44336;
  border: 1px solid rgba(244, 67, 54, 0.5);
}
.user-info {
  position: fixed;
  top: 15px;
  right: 15px;
  background: #222;
  color: #ffeb3b;
  border: 1px solid #555;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 8px;
  z-index: 101;
}
.logout-btn {
  background: #333;
  color: #f44336;
  border: 1px solid #555;
  padding: 3px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 7px;
  margin-left: 6px;
}
.help-btn {
  position: fixed;
  top: 60px;
  right: 15px;
  background: #222;
  color: #2196f3;
  border: 1px solid #555;
  padding: 5px 8px;
  border-radius: 6px;
  text-decoration: none;
  font-size: 7px;
  z-index: 101;
}
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #ffd54f;
  grid-column: 1 / -1;
}
.completed-section,
.statistics-section {
  display: none;
}
.player-filter,
.statistics-filters {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}
.player-filter select,
.statistics-filters select {
  background: #1e1e1e;
  color: #ffd54f;
  border: 1px solid #555;
  padding: 8px 15px;
  border-radius: 10px;
  font-size: 9px;
}
.stat-cards {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}
.stat-card {
  background: #191919;
  padding: 15px;
  border-radius: 12px;
  text-align: center;
  min-width: 140px;
  border: 1px solid #444;
}
.stat-number {
  font-size: 20px;
  color: #ffeb3b;
}
.stat-label {
  font-size: 10px;
  color: #ffd54f;
}
.charts-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 30px;
}
.chart-wrapper {
  background: #191919;
  padding: 15px;
  border-radius: 12px;
  border: 1px solid #444;
}
.chart-title {
  text-align: center;
  color: #ffeb3b;
  font-size: 14px;
  margin-bottom: 10px;
}
.chart-canvas {
  width: 100% !important;
  height: 250px !important;
  min-height: 250px;
  max-height: 250px;
}
</style>
</head>
<body>
<div id="registrationScreen">
  <div class="registration-modal">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input type="text" id="nicknameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º">
    <input type="text" id="adminIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
    <button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <div id="registrationStatus" class="registration-status" style="display: none;"></div>
  </div>
</div>
<div class="mc-background"></div>
<div class="light-overlay"></div>
<div class="sparkles"></div>
<div class="bulb-container">
  <div class="bulb">üí°</div>
</div>
<div class="user-info" id="userInfo" style="display: none;">
  <span id="userNickname"></span>
  <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
</div>
<a href="https://kstrahov333-tech.github.io/klan/gaidi.html" target="_blank" class="help-btn" id="helpBtn" style="display: none;">
  <i class="fas fa-question-circle"></i> –ì–∞–π–¥—ã
</a>
<header>
  <h1>–î–æ—Å–∫–∞ –∑–∞–¥–∞–Ω–∏–π</h1>
</header>
<div class="tabs">
  <button class="tab-btn active" data-tab="active">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</button>
  <button class="tab-btn" data-tab="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</button>
  <button class="tab-btn" data-tab="statistics">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
</div>
<div class="active-section">
  <div class="filter-bar">
    <button class="filter-btn active" data-filter="all">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è</button>
    <button class="filter-btn" data-filter="urgent">–°—Ä–æ—á–Ω—ã–µ</button>
    <button class="filter-btn" data-filter="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ</button>
    <button class="filter-btn" data-filter="normal">–û–±—ã—á–Ω—ã–µ</button>
    <button class="filter-btn" data-filter="inprogress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</button>
  </div>
  <div class="container" id="tasksBoard"></div>
</div>
<div class="completed-section">
  <div class="player-filter">
    <select id="playerFilter">
      <option value="all">–í—Å–µ –∏–≥—Ä–æ–∫–∏</option>
    </select>
  </div>
  <div class="container" id="completedTasksBoard"></div>
</div>
<div class="statistics-section" id="statisticsSection">
  <div class="statistics-filters">
    <select id="statCategoryFilter">
      <option value="all">–í—Å–µ —Ç–∏–ø—ã –∑–∞–¥–∞–Ω–∏–π</option>
      <option value="urgent">–°—Ä–æ—á–Ω—ã–µ</option>
      <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ</option>
      <option value="normal">–û–±—ã—á–Ω—ã–µ</option>
    </select>
    <select id="statPlayerFilter">
      <option value="all">–í—Å–µ –∏–≥—Ä–æ–∫–∏</option>
    </select>
  </div>
  <div class="stat-cards">
    <div class="stat-card">
      <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
      <div class="stat-number" id="totalTasksStat">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
      <div class="stat-number" id="completedTasksStat">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
      <div class="stat-number" id="inProgressTasksStat">0</div>
    </div>
  </div>
  <div class="charts-container">
    <div class="chart-wrapper">
      <div class="chart-title">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ –∏–≥—Ä–æ–∫–∞–º</div>
      <canvas id="playersChart" class="chart-canvas"></canvas>
    </div>
    <div class="chart-wrapper">
      <div class="chart-title">–ó–∞–¥–∞–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
      <canvas id="categoriesChart" class="chart-canvas"></canvas>
    </div>
  </div>
</div>
<button id="addTaskBtn"><i class="fas fa-lightbulb"></i></button>
<div id="addTaskPanel">
  <div class="panel-tabs">
    <button class="panel-tab active" data-panel="newTask">–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
    <button class="panel-tab" data-panel="templates">–®–∞–±–ª–æ–Ω—ã</button>
    <button class="panel-tab" data-panel="packs">–ü–∞–∫–µ—Ç—ã –∑–∞–¥–∞–Ω–∏–π</button>
  </div>
  <div class="panel-content active" id="newTaskPanel">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
    <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è">
    <textarea id="taskDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
    <div class="datetime-inputs">
      <div class="datetime-row">
        <input type="date" id="taskDate">
        <span>–≤</span>
        <input type="time" id="taskTime">
      </div>
    </div>
    <select id="taskCategory">
      <option value="urgent">–°—Ä–æ—á–Ω—ã–µ</option>
      <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ</option>
      <option value="normal">–ù–µ —Å—Ä–æ—á–Ω—ã–µ</option>
    </select>
    <div class="notification-checkbox">
      <input type="checkbox" id="sendNotification" checked>
      <label for="sendNotification">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram</label>
    </div>
    <button id="submitTask">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    <div id="notificationStatus" class="notification-status" style="display: none;"></div>
  </div>
  <div class="panel-content" id="templatesPanel">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏</h3>
    <div class="templates-list" id="templatesList"></div>
    <div style="margin-top: 15px;">
      <h4 style="color: #ffd54f; font-size: 10px; margin-bottom: 10px;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω</h4>
      <input type="text" id="templateTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞">
      <textarea id="templateDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" rows="2"></textarea>
      <select id="templateCategory">
        <option value="urgent">–°—Ä–æ—á–Ω—ã–µ</option>
        <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ</option>
        <option value="normal">–ù–µ —Å—Ä–æ—á–Ω—ã–µ</option>
      </select>
      <div class="template-deadline">
        <div style="font-size: 9px; color: #ffd54f; margin-bottom: 8px;">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</div>
        <div class="datetime-row">
          <input type="date" id="templateDate">
          <span>–≤</span>
          <input type="time" id="templateTime">
        </div>
      </div>
      <button id="createTemplate">–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</button>
    </div>
  </div>
  <div class="panel-content" id="packsPanel">
    <h3>–ü–∞–∫–µ—Ç—ã –∑–∞–¥–∞–Ω–∏–π</h3>
    <div class="packs-list" id="packsList"></div>
    <div style="margin-top: 15px;">
      <h4 style="color: #ffd54f; font-size: 10px; margin-bottom: 10px;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞–∫–µ—Ç</h4>
      <input type="text" id="packTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞">
      <textarea id="packDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞" rows="2"></textarea>
      <div class="pack-templates">
        <div style="font-size: 9px; color: #ffd54f; margin-bottom: 8px;">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –ø–∞–∫–µ—Ç–∞:</div>
        <div id="availableTemplates" class="template-list"></div>
      </div>
      <button id="createPack">–°–æ–∑–¥–∞—Ç—å –ø–∞–∫–µ—Ç</button>
    </div>
  </div>
</div>
<div id="takeModal">
  <div id="modalContent">
    <div id="modalTitle"></div>
    <div style="text-align: center; color: #ffd54f; font-size: 10px; margin-bottom: 15px;">
      –í—ã –±–µ—Ä–µ—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∫–∞–∫: <strong id="currentUserNickname"></strong>
    </div>
    <button id="takeConfirm">–í–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    <button id="takeCancel">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>
<div class="edit-modal">
  <div class="edit-modal-content">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
    <input type="text" id="editTaskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è">
    <textarea id="editTaskDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
    <div class="datetime-inputs">
      <div class="datetime-row">
        <input type="date" id="editTaskDate">
        <span>–≤</span>
        <input type="time" id="editTaskTime">
      </div>
    </div>
    <select id="editTaskCategory">
      <option value="urgent">–°—Ä–æ—á–Ω—ã–µ</option>
      <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ</option>
      <option value="normal">–ù–µ —Å—Ä–æ—á–Ω—ã–µ</option>
    </select>
    <div class="edit-modal-buttons">
      <button class="edit-modal-save" id="saveEditTask">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="edit-modal-cancel" id="cancelEditTask">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, set, get, child } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyAb1xT6mIHlxcZNt1TBS7jrrDp5re3qMOU",
  authDomain: "klan-d9201.firebaseapp.com",
  databaseURL: "https://klan-d9201-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "klan-d9201",
  storageBucket: "klan-d9201.appspot.com",
  messagingSenderId: "252485302766",
  appId: "1:252485302766:web:7f60cca53e9c9b2d38f6ff"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const TELEGRAM_BOT_TOKEN = '8335749049:AAH7Z7uJMoMxSgtqK3-4Paui0ZOO8bf2Cwo';
const registrationScreen = document.getElementById('registrationScreen');
const nicknameInput = document.getElementById('nicknameInput');
const adminIdInput = document.getElementById('adminIdInput');
const registerBtn = document.getElementById('registerBtn');
const registrationStatus = document.getElementById('registrationStatus');
const userInfo = document.getElementById('userInfo');
const userNickname = document.getElementById('userNickname');
const logoutBtn = document.getElementById('logoutBtn');
const helpBtn = document.getElementById('helpBtn');
const addBtn = document.getElementById('addTaskBtn');
const addPanel = document.getElementById('addTaskPanel');
const submitTask = document.getElementById('submitTask');
const taskTitle = document.getElementById('taskTitle');
const taskDesc = document.getElementById('taskDesc');
const taskCategory = document.getElementById('taskCategory');
const taskDate = document.getElementById('taskDate');
const taskTime = document.getElementById('taskTime');
const sendNotification = document.getElementById('sendNotification');
const notificationStatus = document.getElementById('notificationStatus');
const tasksBoard = document.getElementById('tasksBoard');
const completedTasksBoard = document.getElementById('completedTasksBoard');
const filterBtns = document.querySelectorAll('.filter-btn');
const tabBtns = document.querySelectorAll('.tab-btn');
const playerFilter = document.getElementById('playerFilter');
const activeSection = document.querySelector('.active-section');
const completedSection = document.querySelector('.completed-section');
const statisticsSection = document.getElementById('statisticsSection');
const takeModal = document.getElementById('takeModal');
const modalTitle = document.getElementById('modalTitle');
const currentUserNickname = document.getElementById('currentUserNickname');
const takeConfirm = document.getElementById('takeConfirm');
const takeCancel = document.getElementById('takeCancel');
const editModal = document.querySelector('.edit-modal');
const editTaskTitle = document.getElementById('editTaskTitle');
const editTaskDesc = document.getElementById('editTaskDesc');
const editTaskCategory = document.getElementById('editTaskCategory');
const editTaskDate = document.getElementById('editTaskDate');
const editTaskTime = document.getElementById('editTaskTime');
const saveEditTask = document.getElementById('saveEditTask');
const cancelEditTask = document.getElementById('cancelEditTask');
const panelTabs = document.querySelectorAll('.panel-tab');
const panelContents = document.querySelectorAll('.panel-content');
const templatesList = document.getElementById('templatesList');
const templateTitle = document.getElementById('templateTitle');
const templateDesc = document.getElementById('templateDesc');
const templateCategory = document.getElementById('templateCategory');
const templateDate = document.getElementById('templateDate');
const templateTime = document.getElementById('templateTime');
const createTemplateBtn = document.getElementById('createTemplate');
const packsList = document.getElementById('packsList');
const packTitle = document.getElementById('packTitle');
const packDesc = document.getElementById('packDesc');
const availableTemplates = document.getElementById('availableTemplates');
const createPackBtn = document.getElementById('createPack');
const totalTasksStat = document.getElementById('totalTasksStat');
const completedTasksStat = document.getElementById('completedTasksStat');
const inProgressTasksStat = document.getElementById('inProgressTasksStat');
const statCategoryFilter = document.getElementById('statCategoryFilter');
const statPlayerFilter = document.getElementById('statPlayerFilter');

let currentTaskId = null;
let currentFilter = 'all';
let currentTab = 'active';
let editingTaskId = null;
let editingTemplateId = null;
let editingPackId = null;
let selectedTemplates = new Set();
let currentUser = null;
let playersChart = null;
let categoriesChart = null;
let lastSnapshot = null;

const today = new Date().toISOString().split('T')[0];
taskDate.min = today;
editTaskDate.min = today;
templateDate.min = today;
function renderStatistics(snapshot) {
  if (!snapshot) return;

  const categoryFilter = statCategoryFilter.value;
  const playerFilter = statPlayerFilter.value;

  let total = 0, completed = 0, inProgress = 0;
  const playerCounts = {};
  const categoryCounts = { urgent: 0, daily: 0, normal: 0 };

  const allPlayers = new Set();

  snapshot.forEach(s => {
    const data = s.val();
    if (!data) return;

    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –Ω–µ "all")
    if (categoryFilter !== 'all' && data.category !== categoryFilter) return;

    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏ (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞)
    if (data.status === 'completed' && data.player) {
      allPlayers.add(data.player);
    }

    total++;
    if (data.status === 'completed') {
      // –§–∏–ª—å—Ç—Ä –ø–æ –∏–≥—Ä–æ–∫—É
      if (playerFilter !== 'all' && data.player !== playerFilter) return;
      completed++;
      if (data.player) {
        playerCounts[data.player] = (playerCounts[data.player] || 0) + 1;
      }
      categoryCounts[data.category] = (categoryCounts[data.category] || 0) + 1;
    } else if (data.status === 'inprogress') {
      if (playerFilter !== 'all') return; 
      inProgress++;
    }
  });


  updateStatPlayerFilter(allPlayers);

  totalTasksStat.textContent = total;
  completedTasksStat.textContent = completed;
  inProgressTasksStat.textContent = inProgress;

  const players = Object.keys(playerCounts);
  const playerValues = players.map(p => playerCounts[p]);
  const categoryLabels = ['–°—Ä–æ—á–Ω—ã–µ', '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ', '–û–±—ã—á–Ω—ã–µ'];
  const categoryValues = [categoryCounts.urgent, categoryCounts.daily, categoryCounts.normal];
  const colors = ['#ff5252', '#ffb74d', '#ffd54f', '#4caf50', '#2196f3', '#9c27b0', '#ff9800', '#607d8b'];
  const playerColors = Array.from({length: players.length}, (_, i) => colors[i % colors.length]);

  if (playersChart) playersChart.destroy();
  playersChart = new Chart(document.getElementById('playersChart'), {
    type: 'pie',
    data: {
      labels: players,
      datasets: [{
        data: playerValues,
        backgroundColor: playerColors,
        borderWidth: 2,
        borderColor: '#000'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { font: { family: "'Press Start 2P', cursive", size: 8 }, color: '#ffd54f' } },
        tooltip: { bodyFont: { family: "'Press Start 2P', cursive", size: 10 }, titleFont: { family: "'Press Start 2P', cursive", size: 10 } }
      }
    }
  });

  if (categoriesChart) categoriesChart.destroy();
  categoriesChart = new Chart(document.getElementById('categoriesChart'), {
    type: 'bar',
    data: {
      labels: categoryLabels,
      datasets: [{
        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π',
        data: categoryValues,
        backgroundColor: ['#ff5252', '#ffb74d', '#ffd54f'],
        borderWidth: 2,
        borderColor: '#000'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { ticks: { font: { family: "'Press Start 2P', cursive", size: 8 }, color: '#ffd54f' }, beginAtZero: true, grid: { color: 'rgba(255,235,59,0.1)' } },
        x: { ticks: { font: { family: "'Press Start 2P', cursive", size: 8 }, color: '#ffd54f' }, grid: { color: 'rgba(255,235,59,0.1)' } }
      },
      plugins: {
        legend: { labels: { font: { family: "'Press Start 2P', cursive", size: 8 }, color: '#ffd54f' } },
        tooltip: { bodyFont: { family: "'Press Start 2P', cursive", size: 10 }, titleFont: { family: "'Press Start 2P', cursive", size: 10 } }
      }
    }
  });
}

function updateStatPlayerFilter(playersSet) {
  const current = statPlayerFilter.value;
  statPlayerFilter.innerHTML = '<option value="all">–í—Å–µ –∏–≥—Ä–æ–∫–∏</option>';
  const players = Array.from(playersSet).sort();
  players.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p;
    opt.textContent = p;
    statPlayerFilter.appendChild(opt);
  });
  if (players.includes(current)) {
    statPlayerFilter.value = current;
  }
}

// –°–ª—É—à–∞—Ç–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
statCategoryFilter.addEventListener('change', () => {
  if (currentTab === 'statistics') {
    renderStatistics(lastSnapshot);
  }
});
statPlayerFilter.addEventListener('change', () => {
  if (currentTab === 'statistics') {
    renderStatistics(lastSnapshot);
  }
});


async function getSessionInfo() {
  const sessionInfo = {
    timestamp: Date.now(),
    userAgent: navigator.userAgent,
    language: navigator.language,
    platform: navigator.platform,
    screen: `${screen.width}x${screen.height}`,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    cookiesEnabled: navigator.cookieEnabled,
    javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : false,
    online: navigator.onLine,
    deviceMemory: navigator.deviceMemory || 'unknown',
    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
    maxTouchPoints: navigator.maxTouchPoints || 0
  };
  try {
    const ipResponse = await fetch('https://api.ipify.org?format=json');
    const ipData = await ipResponse.json();
    sessionInfo.ip = ipData.ip;
    try {
      const locationResponse = await fetch(`http://ip-api.com/json/${ipData.ip}?fields=status,message,country,countryCode,region,regionName,city,zip,lat,lon,timezone,isp,org,as,query`);
      const locationData = await locationResponse.json();
      if (locationData.status === 'success') {
        sessionInfo.country = locationData.country;
        sessionInfo.countryCode = locationData.countryCode;
        sessionInfo.region = locationData.regionName;
        sessionInfo.city = locationData.city;
        sessionInfo.zip = locationData.zip;
        sessionInfo.lat = locationData.lat;
        sessionInfo.lon = locationData.lon;
        sessionInfo.timezone = locationData.timezone;
        sessionInfo.isp = locationData.isp;
        sessionInfo.org = locationData.org;
        sessionInfo.as = locationData.as;
      }
    } catch (e) {
      console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏');
    }
  } catch (e) {
    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP –∞–¥—Ä–µ—Å');
    sessionInfo.ip = 'unknown';
  }
  sessionInfo.browserInfo = {
    name: navigator.appName,
    version: navigator.appVersion,
    vendor: navigator.vendor,
    product: navigator.product,
    userAgent: navigator.userAgent
  };
  return sessionInfo;
}
async function saveSession(userId, nickname, isNewLogin = false) {
  if (!isNewLogin) return null;
  const sessionInfo = await getSessionInfo();
  sessionInfo.userId = userId;
  sessionInfo.nickname = nickname;
  sessionInfo.loginType = 'new';
  const sessionRef = push(ref(db, 'sessions'));
  set(sessionRef, sessionInfo);
  return sessionRef.key;
}
async function validateUser(user) {
  try {
    const adminsRef = ref(db, 'admins');
    const snapshot = await get(adminsRef);
    if (!snapshot.exists()) {
      return false;
    }
    const admins = snapshot.val();
    for (let adminKey in admins) {
      const admin = admins[adminKey];
      if (admin.nickname === user.nickname && admin.adminId === user.adminId) {
        return true;
      }
    }
    return false;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    return false;
  }
}
function logout() {
  localStorage.removeItem('taskBoardUser');
  localStorage.removeItem('taskBoardLastLogin');
  currentUser = null;
  userInfo.style.display = 'none';
  helpBtn.style.display = 'none';
  registrationScreen.style.display = 'flex';
  showRegistrationStatus('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', false);
}
async function checkRegistration() {
  const savedUser = localStorage.getItem('taskBoardUser');
  const lastLogin = localStorage.getItem('taskBoardLastLogin');
  if (savedUser) {
    const user = JSON.parse(savedUser);
    const isValid = await validateUser(user);
    if (!isValid) {
      logout();
      return false;
    }
    currentUser = user;
    registrationScreen.style.display = 'none';
    userInfo.style.display = 'block';
    helpBtn.style.display = 'flex';
    userNickname.textContent = user.nickname;
    const currentTime = Date.now();
    const isNewLogin = !lastLogin || (currentTime - parseInt(lastLogin)) > 300000;
    if (isNewLogin) {
      saveSession(user.id, user.nickname, true);
      localStorage.setItem('taskBoardLastLogin', currentTime.toString());
    }
    return true;
  }
  return false;
}
async function validateAdmin(nickname, adminId) {
  try {
    const adminsRef = ref(db, 'admins');
    const snapshot = await get(adminsRef);
    if (snapshot.exists()) {
      const admins = snapshot.val();
      for (let adminKey in admins) {
        const admin = admins[adminKey];
        if (admin.nickname === nickname && admin.adminId === adminId) {
          return { valid: true, adminData: admin };
        }
      }
    }
    return { valid: false };
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:', error);
    return { valid: false };
  }
}
registerBtn.addEventListener('click', async () => {
  const nickname = nicknameInput.value.trim();
  const adminId = adminIdInput.value.trim();
  if (!nickname || !adminId) {
    showRegistrationStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', false);
    return;
  }
  const validation = await validateAdmin(nickname, adminId);
  if (validation.valid) {
    const user = {
      id: Date.now().toString(),
      nickname: nickname,
      adminId: adminId,
      registeredAt: Date.now()
    };
    localStorage.setItem('taskBoardUser', JSON.stringify(user));
    localStorage.setItem('taskBoardLastLogin', Date.now().toString());
    currentUser = user;
    await saveSession(user.id, user.nickname, true);
    showRegistrationStatus('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', true);
    setTimeout(() => {
      registrationScreen.style.display = 'none';
      userInfo.style.display = 'block';
      helpBtn.style.display = 'flex';
      userNickname.textContent = user.nickname;
    }, 1500);
  } else {
    showRegistrationStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!', false);
  }
});
logoutBtn.addEventListener('click', () => {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
    logout();
  }
});
function showRegistrationStatus(message, isSuccess) {
  registrationStatus.textContent = message;
  registrationStatus.className = `registration-status ${isSuccess ? 'registration-success' : 'registration-error'}`;
  registrationStatus.style.display = 'block';
  setTimeout(() => {
    registrationStatus.style.display = 'none';
  }, 3000);
}
async function sendTelegramNotification(taskData) {
  if (!sendNotification.checked) return;
  try {
    const updatesResponse = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates`);
    const updatesData = await updatesResponse.json();
    if (!updatesData.ok) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç Telegram');
    }
    const chatIds = new Set();
    if (updatesData.result && updatesData.result.length > 0) {
      updatesData.result.forEach(update => {
        if (update.message && update.message.chat) {
          chatIds.add(update.message.chat.id);
        }
      });
    }
    if (chatIds.size === 0) {
      throw new Error('–ë–æ—Ç –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –Ω–∏ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ –∏–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π');
    }
    const categoryNames = {
      'urgent': 'üö® –°–†–û–ß–ù–û–ï',
      'daily': 'üìÖ –ï–ñ–ï–î–ù–ï–í–ù–û–ï', 
      'normal': 'üìù –û–ë–´–ß–ù–û–ï'
    };
    const categoryName = categoryNames[taskData.category] || 'üìù –ó–ê–î–ê–ù–ò–ï';
    let message = `${categoryName}\n`;
    message += `üìã ${taskData.title}\n`;
    if (taskData.desc) {
      message += `üìù ${taskData.desc}\n`;
    }
    if (taskData.deadline) {
      const deadlineDate = new Date(taskData.deadline);
      message += `‚è∞ –°—Ä–æ–∫: ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString().slice(0,5)}\n`;
    }
    message += `\nüéØ –°—Ç–∞—Ç—É—Å: –û–ñ–ò–î–ê–ï–¢ –í–´–ü–û–õ–ù–ï–ù–ò–Ø`;
    const sendPromises = Array.from(chatIds).map(async (chatId) => {
      const sendResponse = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: chatId, text: message, parse_mode: 'HTML' })
      });
      return sendResponse.json();
    });
    const results = await Promise.all(sendPromises);
    const successfulSends = results.filter(result => result.ok).length;
    return {
      success: true,
      message: `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ ${successfulSends} —á–∞—Ç(–æ–≤)`,
      details: results
    };
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
    return {
      success: false,
      message: `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`
    };
  }
}
function showNotificationStatus(message, isSuccess) {
  notificationStatus.textContent = message;
  notificationStatus.className = `notification-status ${isSuccess ? 'notification-success' : 'notification-error'}`;
  notificationStatus.style.display = 'block';
  setTimeout(() => {
    notificationStatus.style.display = 'none';
  }, 5000);
}
panelTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    panelTabs.forEach(t => t.classList.remove('active'));
    panelContents.forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.panel + 'Panel').classList.add('active');
    if (tab.dataset.panel === 'templates') {
      loadTemplates();
    } else if (tab.dataset.panel === 'packs') {
      loadPacks();
      loadAvailableTemplates();
    }
  });
});
function createSparkles() {
  const sparklesContainer = document.querySelector('.sparkles');
  const sparkleCount = 25;
  for (let i = 0; i < sparkleCount; i++) {
    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle';
    sparkle.style.left = Math.random() * 100 + '%';
    sparkle.style.top = Math.random() * 100 + '%';
    sparkle.style.animationDelay = Math.random() * 3 + 's';
    sparkle.style.animationDuration = (2 + Math.random() * 2) + 's';
    sparkle.style.width = (2 + Math.random() * 3) + 'px';
    sparkle.style.height = sparkle.style.width;
    sparklesContainer.appendChild(sparkle);
  }
}
createSparkles();
tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    tabBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentTab = btn.dataset.tab;
    activeSection.style.display = 'none';
    completedSection.style.display = 'none';
    statisticsSection.style.display = 'none';
    if (currentTab === 'active') {
      activeSection.style.display = 'block';
    } else if (currentTab === 'completed') {
      completedSection.style.display = 'block';
      renderCompletedTasksFromSnapshot(lastSnapshot);
    } else if (currentTab === 'statistics') {
      statisticsSection.style.display = 'block';
      renderStatistics(lastSnapshot);
    }
  });
});
addBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  addPanel.style.display = addPanel.style.display === 'flex' ? 'none' : 'flex';
});
filterBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    filterBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderTasksFromSnapshot(lastSnapshot);
  });
});
submitTask.onclick = async () => {
  const title = taskTitle.value.trim();
  if (!title) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!');
  const desc = taskDesc.value.trim();
  const category = taskCategory.value;
  let deadline = null;
  if (taskDate.value && taskTime.value) {
    const dateTimeString = `${taskDate.value}T${taskTime.value}`;
    deadline = new Date(dateTimeString).getTime();
  }
  if (sendNotification.checked) {
    showNotificationStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', true);
  }
  try {
    let notificationResult = null;
    if (sendNotification.checked) {
      notificationResult = await sendTelegramNotification({ title, desc, category, deadline });
    }
    const taskRef = push(ref(db, 'tasks'), { 
      title, 
      desc, 
      category, 
      deadline, 
      status: 'new'
    });
    if (sendNotification.checked && notificationResult) {
      showNotificationStatus(notificationResult.message, notificationResult.success);
    }
    taskTitle.value = ''; 
    taskDesc.value = ''; 
    taskDate.value = '';
    taskTime.value = '';
    addPanel.style.display = 'none';
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
    showNotificationStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è', false);
  }
};
function loadTemplates() {
  onValue(ref(db, 'templates'), (snapshot) => {
    templatesList.innerHTML = '';
    if (!snapshot.exists()) {
      templatesList.innerHTML = '<div class="empty-state" style="padding: 20px; color: #ffd54f; text-align: center;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</div>';
      return;
    }
    snapshot.forEach(templateSnap => {
      const template = templateSnap.val();
      const templateItem = createTemplateElement(templateSnap.key, template);
      templatesList.appendChild(templateItem);
    });
  });
}
function createTemplateElement(id, template) {
  const item = document.createElement('div');
  item.className = 'template-item';
  let deadlineInfo = '';
  if (template.deadline) {
    const deadlineDate = new Date(template.deadline);
    deadlineInfo = `<div class="template-desc">–°—Ä–æ–∫: ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString().slice(0,5)}</div>`;
  }
  item.innerHTML = `
    <div class="template-info">
      <div class="template-title">${template.title}</div>
      <div class="template-desc">${template.desc || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
      <div class="template-desc">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCategoryName(template.category)}</div>
      ${deadlineInfo}
    </div>
    <div class="template-actions">
      <button class="template-action-btn use-template" title="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω">
        <i class="fas fa-plus"></i>
      </button>
      <button class="template-action-btn edit-template" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
        <i class="fas fa-edit"></i>
      </button>
      <button class="template-action-btn delete-template" title="–£–¥–∞–ª–∏—Ç—å">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  item.querySelector('.use-template').addEventListener('click', (e) => {
    e.stopPropagation();
    useTemplate(template);
  });
  item.querySelector('.edit-template').addEventListener('click', (e) => {
    e.stopPropagation();
    editTemplate(id, template);
  });
  item.querySelector('.delete-template').addEventListener('click', (e) => {
    e.stopPropagation();
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) {
      remove(ref(db, 'templates/' + id));
    }
  });
  return item;
}
function getCategoryName(category) {
  const names = {
    'urgent': '–°—Ä–æ—á–Ω—ã–µ',
    'daily': '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ',
    'normal': '–ù–µ —Å—Ä–æ—á–Ω—ã–µ'
  };
  return names[category] || category;
}
function useTemplate(template) {
  let deadline = template.deadline || null;
  push(ref(db, 'tasks'), {
    title: template.title,
    desc: template.desc || '',
    category: template.category,
    deadline: deadline,
    status: 'new'
  });
  addPanel.style.display = 'none';
}
function editTemplate(id, template) {
  editingTemplateId = id;
  templateTitle.value = template.title;
  templateDesc.value = template.desc || '';
  templateCategory.value = template.category;
  if (template.deadline) {
    const deadlineDate = new Date(template.deadline);
    templateDate.value = deadlineDate.toISOString().split('T')[0];
    templateTime.value = deadlineDate.toTimeString().slice(0, 5);
  } else {
    templateDate.value = '';
    templateTime.value = '';
  }
  createTemplateBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω';
}
createTemplateBtn.addEventListener('click', () => {
  const title = templateTitle.value.trim();
  if (!title) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!');
  let deadline = null;
  if (templateDate.value && templateTime.value) {
    const dateTimeString = `${templateDate.value}T${templateTime.value}`;
    deadline = new Date(dateTimeString).getTime();
  }
  const templateData = {
    title: title,
    desc: templateDesc.value.trim(),
    category: templateCategory.value,
    deadline: deadline
  };
  if (editingTemplateId) {
    update(ref(db, 'templates/' + editingTemplateId), templateData);
    editingTemplateId = null;
    createTemplateBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω';
  } else {
    push(ref(db, 'templates'), templateData);
  }
  templateTitle.value = '';
  templateDesc.value = '';
  templateCategory.value = 'normal';
  templateDate.value = '';
  templateTime.value = '';
});
function loadPacks() {
  onValue(ref(db, 'packs'), (snapshot) => {
    packsList.innerHTML = '';
    if (!snapshot.exists()) {
      packsList.innerHTML = '<div class="empty-state" style="padding: 20px; color: #ffd54f; text-align: center;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤</div>';
      return;
    }
    snapshot.forEach(packSnap => {
      const pack = packSnap.val();
      const packItem = createPackElement(packSnap.key, pack);
      packsList.appendChild(packItem);
    });
  });
}
function loadAvailableTemplates() {
  onValue(ref(db, 'templates'), (snapshot) => {
    availableTemplates.innerHTML = '';
    selectedTemplates.clear();
    if (!snapshot.exists()) {
      availableTemplates.innerHTML = '<div style="color: #ffd54f; text-align: center; padding: 10px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</div>';
      return;
    }
    snapshot.forEach(templateSnap => {
      const template = templateSnap.val();
      const templateItem = document.createElement('div');
      templateItem.className = 'template-list-item';
      templateItem.innerHTML = `
        <input type="checkbox" id="template_${templateSnap.key}" value="${templateSnap.key}">
        <label for="template_${templateSnap.key}" style="margin-left: 5px;">${template.title}</label>
      `;
      templateItem.querySelector('input').addEventListener('change', (e) => {
        if (e.target.checked) {
          selectedTemplates.add(templateSnap.key);
        } else {
          selectedTemplates.delete(templateSnap.key);
        }
      });
      availableTemplates.appendChild(templateItem);
    });
  });
}
function createPackElement(id, pack) {
  const item = document.createElement('div');
  item.className = 'pack-item';
  let templatesInfo = '';
  if (pack.templates && Object.keys(pack.templates).length > 0) {
    templatesInfo = `<div class="pack-desc">–ó–∞–¥–∞–Ω–∏–π: ${Object.keys(pack.templates).length}</div>`;
  }
  item.innerHTML = `
    <div class="pack-info">
      <div class="pack-title">${pack.title}</div>
      <div class="pack-desc">${pack.desc || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
      ${templatesInfo}
    </div>
    <div class="pack-actions">
      <button class="pack-action-btn use-pack" title="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç">
        <i class="fas fa-layer-group"></i>
      </button>
      <button class="pack-action-btn edit-pack" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
        <i class="fas fa-edit"></i>
      </button>
      <button class="pack-action-btn delete-pack" title="–£–¥–∞–ª–∏—Ç—å">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  item.querySelector('.use-pack').addEventListener('click', (e) => {
    e.stopPropagation();
    usePack(pack);
  });
  item.querySelector('.edit-pack').addEventListener('click', (e) => {
    e.stopPropagation();
    editPack(id, pack);
  });
  item.querySelector('.delete-pack').addEventListener('click', (e) => {
    e.stopPropagation();
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–∞–∫–µ—Ç?')) {
      remove(ref(db, 'packs/' + id));
    }
  });
  return item;
}
function usePack(pack) {
  if (!pack.templates) return;
  Object.values(pack.templates).forEach(templateId => {
    getTemplateById(templateId).then(template => {
      if (template) {
        let deadline = template.deadline || null;
        push(ref(db, 'tasks'), {
          title: template.title,
          desc: template.desc || '',
          category: template.category,
          deadline: deadline,
          status: 'new'
        });
      }
    });
  });
  addPanel.style.display = 'none';
}
function getTemplateById(templateId) {
  return new Promise((resolve) => {
    onValue(ref(db, 'templates/' + templateId), (snapshot) => {
      resolve(snapshot.val());
    }, { onlyOnce: true });
  });
}
function editPack(id, pack) {
  editingPackId = id;
  packTitle.value = pack.title;
  packDesc.value = pack.desc || '';
  selectedTemplates.clear();
  if (pack.templates) {
    Object.values(pack.templates).forEach(templateId => {
      selectedTemplates.add(templateId);
    });
  }
  createPackBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–∫–µ—Ç';
}
createPackBtn.addEventListener('click', () => {
  const title = packTitle.value.trim();
  if (!title) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!');
  if (selectedTemplates.size === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω –¥–ª—è –ø–∞–∫–µ—Ç–∞!');
  const packData = {
    title: title,
    desc: packDesc.value.trim(),
    templates: Object.fromEntries(Array.from(selectedTemplates).map((id, index) => [index, id]))
  };
  if (editingPackId) {
    update(ref(db, 'packs/' + editingPackId), packData);
    editingPackId = null;
    createPackBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –ø–∞–∫–µ—Ç';
  } else {
    push(ref(db, 'packs'), packData);
  }
  packTitle.value = '';
  packDesc.value = '';
  selectedTemplates.clear();
  const checkboxes = availableTemplates.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
});
function checkMidnightReset(tasks) {
  const now = Date.now();
  tasks.forEach(task => {
    const taskData = task.data;
    if (taskData.resetAtMidnight && taskData.nextResetTime && now >= taskData.nextResetTime) {
      if (taskData.status === 'completed') {
        update(ref(db, 'tasks/' + task.id), {
          status: 'new',
          player: null,
          completedAt: null,
          nextResetTime: getNextMidnight()
        });
      } else {
        update(ref(db, 'tasks/' + task.id), {
          nextResetTime: getNextMidnight()
        });
      }
    }
  });
}
function createTaskCard(id, data) {
  const card = document.createElement('div');
  card.className = `taskCard ${data.status === 'inprogress' ? 'inprogress' : data.status === 'completed' ? 'completed' : data.category}`;
  card.dataset.category = data.status === 'inprogress' ? 'inprogress' : data.status === 'completed' ? 'completed' : data.category;
  const header = document.createElement('div');
  header.className='taskHeader';
  const titleEl = document.createElement('div');
  titleEl.className='taskTitle';
  titleEl.textContent = data.title;
  const moreBtn = document.createElement('div');
  moreBtn.className='moreBtn';
  moreBtn.innerHTML='<i class="fas fa-ellipsis-v"></i>';
  const moreMenu = document.createElement('div');
  moreMenu.className='moreMenu';
  const editBtn = document.createElement('button');
  editBtn.innerHTML='<i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
  const delBtn = document.createElement('button');
  delBtn.innerHTML='<i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å';
  moreMenu.append(editBtn, delBtn);
  moreBtn.onclick = (e) => {
    e.stopPropagation();
    moreMenu.style.display = moreMenu.style.display==='flex'?'none':'flex';
  };
  editBtn.onclick = ()=> {
    editingTaskId = id;
    editTaskTitle.value = data.title;
    editTaskDesc.value = data.desc || '';
    editTaskCategory.value = data.category;
    if (data.deadline) {
      const deadlineDate = new Date(data.deadline);
      editTaskDate.value = deadlineDate.toISOString().split('T')[0];
      editTaskTime.value = deadlineDate.toTimeString().slice(0, 5);
    } else {
      editTaskDate.value = '';
      editTaskTime.value = '';
    }
    editModal.style.display = 'flex';
    moreMenu.style.display = 'none';
  };
  delBtn.onclick = ()=> {
    if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ?')) {
      remove(ref(db,'tasks/'+id));
    }
    moreMenu.style.display = 'none';
  };
  document.addEventListener('click', (e) => {
    if (!moreMenu.contains(e.target) && !moreBtn.contains(e.target)) {
      moreMenu.style.display = 'none';
    }
  });
  header.append(titleEl, moreBtn, moreMenu);
  const descEl = document.createElement('div');
  descEl.className='taskDesc';
  descEl.textContent=data.desc || '';
  const footer = document.createElement('div');
  footer.className='taskFooter';
  const priorityLabel = document.createElement('div');
  priorityLabel.className='priorityLabel';
  if (data.status === 'inprogress') {
    priorityLabel.textContent = '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
    const playerTag = document.createElement('div');
    playerTag.className='playerNameTag';
    playerTag.textContent = data.player || '???';
    footer.append(priorityLabel, playerTag);
  } else if (data.status === 'completed') {
    priorityLabel.textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
    const playerTag = document.createElement('div');
    playerTag.className='playerNameTag';
    playerTag.textContent = data.player || '???';
    const completedDate = document.createElement('div');
    completedDate.className='countdown';
    completedDate.textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${new Date(data.completedAt).toLocaleDateString()}`;
    footer.append(priorityLabel, playerTag);
    card.append(completedDate);
  } else {
    priorityLabel.textContent = data.category==='urgent'?'–°—Ä–æ—á–Ω–æ–µ':data.category==='daily'?'–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ':'–û–±—ã—á–Ω–æ–µ';
    footer.append(priorityLabel);
  }
  card.append(header, descEl);
  if(data.deadline && data.status !== 'completed'){
    const countdown = document.createElement('div');
    countdown.className='countdown';
    card.append(countdown);
    const updateCountdown = () => {
      const now=Date.now();
      const diff=Math.max(0, data.deadline-now);
      const d=Math.floor(diff/86400000);
      const h=Math.floor((diff%86400000)/3600000);
      const m=Math.floor((diff%3600000)/60000);
      const s=Math.floor((diff%60000)/1000);
      countdown.textContent=`‚è±Ô∏è ${d}–¥ ${h}—á ${m}–º ${s}—Å`;
    };
    updateCountdown();
    const countdownInterval = setInterval(updateCountdown, 1000);
    card.dataset.countdownInterval = countdownInterval;
  }
  if (data.status === 'new') {
    const takeBtn = document.createElement('button');
    takeBtn.className='takeBtn';
    takeBtn.innerHTML='<i class="fas fa-hand-paper"></i> –í–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
    takeBtn.onclick = ()=> {
      if (!currentUser) {
        alert('–°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è!');
        return;
      }
      currentTaskId = id;
      modalTitle.textContent = data.title;
      currentUserNickname.textContent = currentUser.nickname;
      takeModal.style.display='flex';
    };
    card.append(takeBtn);
  } else if (data.status === 'inprogress') {
    const completeBtn = document.createElement('button');
    completeBtn.className='completeBtn';
    completeBtn.innerHTML='<i class="fas fa-check"></i> –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ';
    completeBtn.onclick = () => {
      card.style.animation = 'flyAway 1s forwards';
      setTimeout(() => {
        update(ref(db, 'tasks/' + id), {
          status: 'completed',
          completedAt: Date.now()
        });
      }, 1000);
    };
    card.append(completeBtn);
  }
  card.append(footer);
  return card;
}
function renderTasksFromSnapshot(snapshot){
  if (!snapshot) return;
  tasksBoard.innerHTML='';
  const tasks = [];
  snapshot.forEach(s=>{
    const taskData = s.val();
    if (taskData.status !== 'completed') {
      tasks.push({id:s.key, data:taskData});
    }
  });
  checkMidnightReset(tasks);
  const filteredTasks = tasks.filter(task => {
    if (currentFilter === 'all') return true;
    if (currentFilter === 'inprogress') return task.data.status === 'inprogress';
    return task.data.category === currentFilter && task.data.status !== 'inprogress';
  });
  if (filteredTasks.length === 0) {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    emptyState.innerHTML = `
      <i class="fas fa-tasks"></i>
      <p>–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
      <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –ª–∞–º–ø–æ—á–∫–∏</p>
    `;
    tasksBoard.append(emptyState);
    return;
  }
  const prio={'urgent':4,'daily':3,'normal':2,'inprogress':1};
  filteredTasks.sort((a,b)=> (prio[b.data.category]||0)-(prio[a.data.category]||0));
  filteredTasks.forEach(t=>tasksBoard.append(createTaskCard(t.id,t.data)));
}
function renderCompletedTasksFromSnapshot(snapshot) {
  if (!snapshot) return;
  completedTasksBoard.innerHTML='';
  const tasks = [];
  const players = new Set();
  snapshot.forEach(s=>{
    const taskData = s.val();
    if (taskData.status === 'completed') {
      tasks.push({id:s.key, data:taskData});
      if (taskData.player) {
        players.add(taskData.player);
      }
    }
  });
  updatePlayerFilter(players);
  const selectedPlayer = playerFilter.value;
  const filteredTasks = selectedPlayer === 'all' 
    ? tasks 
    : tasks.filter(task => task.data.player === selectedPlayer);
  if (filteredTasks.length === 0) {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    emptyState.innerHTML = `
      <i class="fas fa-check-circle"></i>
      <p>–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
      <p>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
    `;
    completedTasksBoard.append(emptyState);
    return;
  }
  filteredTasks.sort((a, b) => (b.data.completedAt || 0) - (a.data.completedAt || 0));
  filteredTasks.forEach(t => completedTasksBoard.append(createTaskCard(t.id, t.data)));
}
function updatePlayerFilter(players) {
  const currentValue = playerFilter.value;
  playerFilter.innerHTML = '<option value="all">–í—Å–µ –∏–≥—Ä–æ–∫–∏</option>';
  const sortedPlayers = Array.from(players).sort();
  sortedPlayers.forEach(player => {
    const option = document.createElement('option');
    option.value = player;
    option.textContent = player;
    playerFilter.appendChild(option);
  });
  if (sortedPlayers.includes(currentValue)) {
    playerFilter.value = currentValue;
  }
}
function renderTasks(snapshot){
  lastSnapshot = snapshot;
  if (currentTab === 'active') {
    renderTasksFromSnapshot(snapshot);
  } else if (currentTab === 'completed') {
    renderCompletedTasksFromSnapshot(snapshot);
  } else if (currentTab === 'statistics') {
    renderStatistics(snapshot);
  }
}
onValue(ref(db,'tasks'), renderTasks);
playerFilter.addEventListener('change', () => {
  renderCompletedTasksFromSnapshot(lastSnapshot);
});
saveEditTask.onclick = () => {
  const title = editTaskTitle.value.trim();
  if (!title) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!');
  const desc = editTaskDesc.value.trim();
  const category = editTaskCategory.value;
  let deadline = null;
  if (editTaskDate.value && editTaskTime.value) {
    const dateTimeString = `${editTaskDate.value}T${editTaskTime.value}`;
    deadline = new Date(dateTimeString).getTime();
  }
  update(ref(db, 'tasks/' + editingTaskId), { 
    title, 
    desc, 
    category, 
    deadline
  });
  editModal.style.display = 'none';
  editingTaskId = null;
};
cancelEditTask.onclick = () => {
  editModal.style.display = 'none';
  editingTaskId = null;
};
takeConfirm.onclick = ()=>{
  if (!currentUser) {
    alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!');
    takeModal.style.display='none';
    return;
  }
  update(ref(db,'tasks/'+currentTaskId),{
    status:'inprogress',
    player: currentUser.nickname
  });
  takeModal.style.display='none';
};
takeCancel.onclick = ()=>takeModal.style.display='none';
takeModal.addEventListener('click', (e) => {
  if (e.target === takeModal) {
    takeModal.style.display = 'none';
  }
});
editModal.addEventListener('click', (e) => {
  if (e.target === editModal) {
    editModal.style.display = 'none';
    editingTaskId = null;
  }
});
document.addEventListener('click', (e) => {
  if (!addPanel.contains(e.target) && e.target !== addBtn) {
    addPanel.style.display = 'none';
  }
});
loadTemplates();
loadPacks();
document.addEventListener('DOMContentLoaded', async () => {
  if (!await checkRegistration()) {
    registrationScreen.style.display = 'flex';
  }
});
function monitorAdmins() {
  onValue(ref(db, 'admins'), async (snapshot) => {
    if (currentUser) {
      const isValid = await validateUser(currentUser);
      if (!isValid) {
        logout();
      }
    }
  });
}
monitorAdmins();
</script>
</body>
</html>